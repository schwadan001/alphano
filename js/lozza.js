var BUILD="1.18",HOST_WEB=0,HOST_NODEJS=1,HOST_JSUCI=2,HOSTS=["Web","Node","jsUCI"],lozzaHost=HOST_WEB;"undefined"!=typeof process?lozzaHost=HOST_NODEJS:"undefined"!=typeof lastMessage&&(lozzaHost=HOST_JSUCI),function(t,s,i,h,e,S,_,o,r){var E,a=i.pow(h,6),n=i.pow(2,52),O=2*n,T=h-1,A=i.seedrandom=function(e,S,_){var o=[],r=M(function t(s,i){var h,e=[],S=typeof s;if(i&&"object"==S)for(h in s)try{e.push(t(s[h],i-1))}catch(t){}return e.length?e:"string"==S?s:s+"\0"}((S=1==S?{entropy:!0}:S||{}).entropy?[e,I(s)]:null==e?function(i){try{return E?I(E.randomBytes(h)):(t.crypto.getRandomValues(i=new Uint8Array(h)),I(i))}catch(h){return[+new Date,t,(i=t.navigator)&&i.plugins,t.screen,I(s)]}}():e,3),o),T=new P(o);return M(I(T.S),s),(S.pass||_||function(t,s,h){return h?(i.random=t,s):t})(function(){for(var t=T.g(6),s=a,i=0;t<n;)t=(t+i)*h,s*=h,i=T.g(1);for(;t>=O;)t/=2,s/=2,i>>>=1;return(t+i)/s},r,"global"in S?S.global:this==i)};function P(t){var s,i=t.length,e=this,S=0,_=e.i=e.j=0,o=e.S=[];for(i||(t=[i++]);S<h;)o[S]=S++;for(S=0;S<h;S++)o[S]=o[_=T&_+t[S%i]+(s=o[S])],o[_]=s;(e.g=function(t){for(var s,i=0,S=e.i,_=e.j,o=e.S;t--;)s=o[S=T&S+1],i=i*h+o[T&(o[S]=o[_=T&_+s])+(o[_]=s)];return e.i=S,e.j=_,i})(h)}function M(t,s){for(var i,h=t+"",e=0;e<h.length;)s[T&e]=T&(i^=19*s[T&e])+h.charCodeAt(e++);return I(s)}function I(t){return String.fromCharCode.apply(0,t)}if(M(i.random(),s),_&&_.exports){_.exports=A;try{E=require("crypto")}catch(t){}}else o&&o.amd&&o(function(){return A})}(this,[],Math,256,0,0,"object"==typeof module&&module,"function"==typeof define&&define),Math.seedrandom("Lozza rules OK");var MAX_PLY=100,MAX_MOVES=250,INFINITY=3e4,MATE=2e4,MINMATE=MATE-2*MAX_PLY,CONTEMPT=0,NULL_Y=1,NULL_N=0,INCHECK_UNKNOWN=MATE+1,TTSCORE_UNKNOWN=MATE+2,ASP_MAX=75,ASP_DELTA=3,ASP_MIN=10,EMPTY=0,UCI_FMT=0,SAN_FMT=1,WHITE=0,BLACK=8,I_WHITE=0,I_BLACK=1,M_WHITE=1,M_BLACK=-1,PIECE_MASK=7,COLOR_MASK=8,TT_EMPTY=0,TT_EXACT=1,TT_BETA=2,TT_ALPHA=3,MOVE_TO_BITS=0,MOVE_FR_BITS=8,MOVE_TOOBJ_BITS=16,MOVE_FROBJ_BITS=20,MOVE_PROMAS_BITS=29,MOVE_TO_MASK=255,MOVE_FR_MASK=65280,MOVE_TOOBJ_MASK=983040,MOVE_FROBJ_MASK=15728640,MOVE_PAWN_MASK=16777216,MOVE_EPTAKE_MASK=33554432,MOVE_EPMAKE_MASK=67108864,MOVE_CASTLE_MASK=134217728,MOVE_PROMOTE_MASK=268435456,MOVE_PROMAS_MASK=1610612736,MOVE_SPARE2_MASK=2147483648,MOVE_SPECIAL_MASK=MOVE_CASTLE_MASK|MOVE_PROMOTE_MASK|MOVE_EPTAKE_MASK|MOVE_EPMAKE_MASK,KEEPER_MASK=MOVE_CASTLE_MASK|MOVE_PROMOTE_MASK|MOVE_EPTAKE_MASK|MOVE_TOOBJ_MASK,NULL=0,PAWN=1,KNIGHT=2,BISHOP=3,ROOK=4,QUEEN=5,KING=6,EDGE=7,NO_Z=8,W_PAWN=PAWN,W_KNIGHT=KNIGHT,W_BISHOP=BISHOP,W_ROOK=ROOK,W_QUEEN=QUEEN,W_KING=KING,B_PAWN=PAWN|BLACK,B_KNIGHT=KNIGHT|BLACK,B_BISHOP=BISHOP|BLACK,B_ROOK=ROOK|BLACK,B_QUEEN=QUEEN|BLACK,B_KING=KING|BLACK,IS_O=[0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0],IS_E=[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],IS_OE=[1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0],IS_KN=[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],IS_P=[0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0],IS_NBRQKE=[1,0,1,1,1,1,1,0,0,0,1,1,1,1,1,0],IS_RQKE=[1,0,0,0,1,1,1,0,0,0,0,0,1,1,1,0],IS_QKE=[1,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0],IS_W=[0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0],IS_WE=[1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0],IS_WP=[0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],IS_WN=[0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0],IS_WB=[0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],IS_WBQ=[0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0],IS_WRQ=[0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0],IS_B=[0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0],IS_BE=[1,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0],IS_BP=[0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0],IS_BN=[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],IS_BB=[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],IS_BBQ=[0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0],IS_BRQ=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0],PPHASE=0,NPHASE=1,BPHASE=1,RPHASE=2,QPHASE=4,VPHASE=[0,PPHASE,NPHASE,BPHASE,RPHASE,QPHASE,0],TPHASE=16*PPHASE+4*NPHASE+4*BPHASE+4*RPHASE+2*QPHASE,EPHASE=180,A1=110,B1=111,C1=112,D1=113,E1=114,F1=115,G1=116,H1=117,A8=26,B8=27,C8=28,D8=29,E8=30,F8=31,G8=32,H8=33,SQA1=110,SQB1=111,SQC1=112,SQD1=113,SQE1=114,SQF1=115,SQG1=116,SQH1=117,SQA2=98,SQB2=99,SQC2=100,SQD2=101,SQE2=102,SQF2=103,SQG2=104,SQH2=105,SQA3=86,SQB3=87,SQC3=88,SQD3=89,SQE3=90,SQF3=91,SQG3=92,SQH3=93,SQA4=74,SQB4=75,SQC4=76,SQD4=77,SQE4=78,SQF4=79,SQG4=80,SQH4=81,SQA5=62,SQB5=63,SQC5=64,SQD5=65,SQE5=66,SQF5=67,SQG5=68,SQH5=69,SQA6=50,SQB6=51,SQC6=52,SQD6=53,SQE6=54,SQF6=55,SQG6=56,SQH6=57,SQA7=38,SQB7=39,SQC7=40,SQD7=41,SQE7=42,SQF7=43,SQG7=44,SQH7=45,SQA8=26,SQB8=27,SQC8=28,SQD8=29,SQE8=30,SQF8=31,SQG8=32,SQH8=33,MOVE_E1G1=MOVE_CASTLE_MASK|W_KING<<MOVE_FROBJ_BITS|E1<<MOVE_FR_BITS|G1,MOVE_E1C1=MOVE_CASTLE_MASK|W_KING<<MOVE_FROBJ_BITS|E1<<MOVE_FR_BITS|C1,MOVE_E8G8=MOVE_CASTLE_MASK|B_KING<<MOVE_FROBJ_BITS|E8<<MOVE_FR_BITS|G8,MOVE_E8C8=MOVE_CASTLE_MASK|B_KING<<MOVE_FROBJ_BITS|E8<<MOVE_FR_BITS|C8,WHITE_RIGHTS_KING=1,WHITE_RIGHTS_QUEEN=2,BLACK_RIGHTS_KING=4,BLACK_RIGHTS_QUEEN=8,WHITE_RIGHTS=WHITE_RIGHTS_QUEEN|WHITE_RIGHTS_KING,BLACK_RIGHTS=BLACK_RIGHTS_QUEEN|BLACK_RIGHTS_KING,MASK_RIGHTS=[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,-9,15,15,15,-13,15,15,-5,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,-3,15,15,15,-4,15,15,-2,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15],WP_OFFSET_ORTH=-12,WP_OFFSET_DIAG1=-13,WP_OFFSET_DIAG2=-11,BP_OFFSET_ORTH=12,BP_OFFSET_DIAG1=13,BP_OFFSET_DIAG2=11,KNIGHT_OFFSETS=[25,-25,23,-23,14,-14,10,-10],BISHOP_OFFSETS=[11,-11,13,-13],ROOK_OFFSETS=[1,-1,12,-12],QUEEN_OFFSETS=[11,-11,13,-13,1,-1,12,-12],KING_OFFSETS=[11,-11,13,-13,1,-1,12,-12],OFFSETS=[0,0,KNIGHT_OFFSETS,BISHOP_OFFSETS,ROOK_OFFSETS,QUEEN_OFFSETS,KING_OFFSETS],LIMITS=[0,1,1,8,8,8,1],VALUE_PAWN=100,VALUE_KNIGHT=325,VALUE_BISHOP=325,VALUE_ROOK=500,VALUE_QUEEN=1e3,VALUE_KING=1e4,VALUE_VECTOR=[0,VALUE_PAWN,VALUE_KNIGHT,VALUE_BISHOP,VALUE_ROOK,VALUE_QUEEN,VALUE_KING],RANK_VECTOR=[0,1,2,2,4,5,6],NULL_PST=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WPAWN_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-15,-5,0,5,5,0,-5,-15,0,0,0,0,-15,-5,0,5,5,0,-5,-15,0,0,0,0,-15,-5,0,5,5,0,-5,-15,0,0,0,0,-15,-5,0,15,15,0,-5,-15,0,0,0,0,-15,-5,0,25,25,0,-5,-15,0,0,0,0,-15,-5,0,15,15,0,-5,-15,0,0,0,0,-15,-5,0,5,5,0,-5,-15,0,0,0,0,-15,-5,0,5,5,0,-5,-15,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WPAWN_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WKNIGHT_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-135,-25,-15,-10,-10,-15,-25,-135,0,0,0,0,-20,-10,0,5,5,0,-10,-20,0,0,0,0,-5,5,15,20,20,15,5,-5,0,0,0,0,-5,5,15,20,20,15,5,-5,0,0,0,0,-10,0,10,15,15,10,0,-10,0,0,0,0,-20,-10,0,5,5,0,-10,-20,0,0,0,0,-35,-25,-15,-10,-10,-15,-25,-35,0,0,0,0,-50,-40,-30,-25,-25,-30,-40,-50,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WKNIGHT_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-40,-30,-20,-15,-15,-20,-30,-40,0,0,0,0,-30,-20,-10,-5,-5,-10,-20,-30,0,0,0,0,-20,-10,0,5,5,0,-10,-20,0,0,0,0,-15,-5,5,10,10,5,-5,-15,0,0,0,0,-15,-5,5,10,10,5,-5,-15,0,0,0,0,-20,-10,0,5,5,0,-10,-20,0,0,0,0,-30,-20,-10,-5,-5,-10,-20,-30,0,0,0,0,-40,-30,-20,-15,-15,-20,-30,-40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WBISHOP_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-8,-8,-6,-4,-4,-6,-8,-8,0,0,0,0,-8,0,-2,0,0,-2,0,-8,0,0,0,0,-6,-2,4,2,2,4,-2,-6,0,0,0,0,-4,0,2,8,8,2,0,-4,0,0,0,0,-4,0,2,8,8,2,0,-4,0,0,0,0,-6,-2,4,2,2,4,-2,-6,0,0,0,0,-8,0,-2,0,0,-2,0,-8,0,0,0,0,-18,-18,-16,-14,-14,-16,-18,-18,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WBISHOP_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-18,-12,-9,-6,-6,-9,-12,-18,0,0,0,0,-12,-6,-3,0,0,-3,-6,-12,0,0,0,0,-9,-3,0,3,3,0,-3,-9,0,0,0,0,-6,0,3,6,6,3,0,-6,0,0,0,0,-6,0,3,6,6,3,0,-6,0,0,0,0,-9,-3,0,3,3,0,-3,-9,0,0,0,0,-12,-6,-3,0,0,-3,-6,-12,0,0,0,0,-18,-12,-9,-6,-6,-9,-12,-18,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WROOK_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-6,-3,0,3,3,0,-3,-6,0,0,0,0,-6,-3,0,3,3,0,-3,-6,0,0,0,0,-6,-3,0,3,3,0,-3,-6,0,0,0,0,-5,-3,0,3,3,0,-3,-6,0,0,0,0,-5,-3,0,3,3,0,-3,-6,0,0,0,0,-5,-3,0,3,3,0,-3,-6,0,0,0,0,-5,-3,0,3,3,0,-3,-6,0,0,0,0,-6,-3,0,3,3,0,-3,-6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WROOK_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WQUEEN_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-5,-5,-5,-5,-5,-5,-5,-5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WQUEEN_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-24,-16,-12,-8,-8,-12,-16,-24,0,0,0,0,-16,-8,-4,0,0,-4,-8,-16,0,0,0,0,-12,-4,0,4,4,0,-4,-12,0,0,0,0,-8,0,4,8,8,4,0,-8,0,0,0,0,-8,0,4,8,8,4,0,-8,0,0,0,0,-12,-4,0,4,4,0,-4,-12,0,0,0,0,-16,-8,-4,0,0,-4,-8,-16,0,0,0,0,-24,-16,-12,-8,-8,-12,-16,-24,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WKING_PSTS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-40,-30,-50,-70,-70,-50,-30,-40,0,0,0,0,-30,-20,-40,-60,-60,-40,-20,-30,0,0,0,0,-20,-10,-30,-50,-50,-30,-10,-20,0,0,0,0,-10,0,-20,-40,-40,-20,0,-10,0,0,0,0,0,10,-10,-30,-30,-10,10,0,0,0,0,0,10,20,0,-20,-20,0,20,10,0,0,0,0,30,40,20,0,0,20,40,30,0,0,0,0,40,50,30,10,10,30,50,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WKING_PSTE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-72,-48,-36,-24,-24,-36,-48,-72,0,0,0,0,-48,-24,-12,0,0,-12,-24,-48,0,0,0,0,-36,-12,0,12,12,0,-12,-36,0,0,0,0,-24,0,12,24,24,12,0,-24,0,0,0,0,-24,0,12,24,24,12,0,-24,0,0,0,0,-36,-12,0,12,12,0,-12,-36,0,0,0,0,-48,-24,-12,0,0,-12,-24,-48,0,0,0,0,-72,-48,-36,-24,-24,-36,-38,-72,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WOUTPOST=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,5,5,4,0,0,0,0,0,0,0,2,5,10,10,5,2,0,0,0,0,0,0,2,5,10,10,5,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];function _pst2Black(t,s){for(var i=0;i<12;i++)for(var h=12*i,e=12*(11-i),S=0;S<12;S++)s[e+S]=t[h+S]}var BPAWN_PSTS=Array(144),BPAWN_PSTE=Array(144),BKNIGHT_PSTS=Array(144),BKNIGHT_PSTE=Array(144),BBISHOP_PSTS=Array(144),BBISHOP_PSTE=Array(144),BROOK_PSTS=Array(144),BROOK_PSTE=Array(144),BQUEEN_PSTS=Array(144),BQUEEN_PSTE=Array(144),BKING_PSTS=Array(144),BKING_PSTE=Array(144),BOUTPOST=Array(144);_pst2Black(WPAWN_PSTS,BPAWN_PSTS),_pst2Black(WPAWN_PSTE,BPAWN_PSTE),_pst2Black(WKNIGHT_PSTS,BKNIGHT_PSTS),_pst2Black(WKNIGHT_PSTE,BKNIGHT_PSTE),_pst2Black(WBISHOP_PSTS,BBISHOP_PSTS),_pst2Black(WBISHOP_PSTE,BBISHOP_PSTE),_pst2Black(WROOK_PSTS,BROOK_PSTS),_pst2Black(WROOK_PSTE,BROOK_PSTE),_pst2Black(WQUEEN_PSTS,BQUEEN_PSTS),_pst2Black(WQUEEN_PSTE,BQUEEN_PSTE),_pst2Black(WKING_PSTS,BKING_PSTS),_pst2Black(WKING_PSTE,BKING_PSTE);var WS_PST=[NULL_PST,WPAWN_PSTS,WKNIGHT_PSTS,WBISHOP_PSTS,WROOK_PSTS,WQUEEN_PSTS,WKING_PSTS],WE_PST=[NULL_PST,WPAWN_PSTE,WKNIGHT_PSTE,WBISHOP_PSTE,WROOK_PSTE,WQUEEN_PSTE,WKING_PSTE],WM_PST=[NULL_PST,WPAWN_PSTE,WKNIGHT_PSTE,WBISHOP_PSTE,WROOK_PSTE,WQUEEN_PSTE,WKING_PSTE],BS_PST=[NULL_PST,BPAWN_PSTS,BKNIGHT_PSTS,BBISHOP_PSTS,BROOK_PSTS,BQUEEN_PSTS,BKING_PSTS],BE_PST=[NULL_PST,BPAWN_PSTE,BKNIGHT_PSTE,BBISHOP_PSTE,BROOK_PSTE,BQUEEN_PSTE,BKING_PSTE],BM_PST=[NULL_PST,BPAWN_PSTE,BKNIGHT_PSTE,BBISHOP_PSTE,BROOK_PSTE,BQUEEN_PSTE,BKING_PSTE];_pst2Black(WOUTPOST,BOUTPOST);var B88=[26,27,28,29,30,31,32,33,38,39,40,41,42,43,44,45,50,51,52,53,54,55,56,57,62,63,64,65,66,67,68,69,74,75,76,77,78,79,80,81,86,87,88,89,90,91,92,93,98,99,100,101,102,103,104,105,110,111,112,113,114,115,116,117],COORDS=["??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","a8","b8","c8","d8","e8","f8","g8","h8","??","??","??","??","a7","b7","c7","d7","e7","f7","g7","h7","??","??","??","??","a6","b6","c6","d6","e6","f6","g6","h6","??","??","??","??","a5","b5","c5","d5","e5","f5","g5","h5","??","??","??","??","a4","b4","c4","d4","e4","f4","g4","h4","??","??","??","??","a3","b3","c3","d3","e3","f3","g3","h3","??","??","??","??","a2","b2","c2","d2","e2","f2","g2","h2","??","??","??","??","a1","b1","c1","d1","e1","f1","g1","h1","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??","??"],NAMES=["-","P","N","B","R","Q","K","-"],PROMOTES=["n","b","r","q"],RANK=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,8,8,8,8,8,8,8,0,0,0,0,7,7,7,7,7,7,7,7,0,0,0,0,6,6,6,6,6,6,6,6,0,0,0,0,5,5,5,5,5,5,5,5,0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0,3,3,3,3,3,3,3,3,0,0,0,0,2,2,2,2,2,2,2,2,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],FILE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],CORNERS=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],WSQUARE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],BSQUARE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],DIAG1=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,0,0,0,0,2,3,4,5,6,7,8,9,0,0,0,0,3,4,5,6,7,8,9,10,0,0,0,0,4,5,6,7,8,9,10,11,0,0,0,0,5,6,7,8,9,10,11,12,0,0,0,0,6,7,8,9,10,11,12,13,0,0,0,0,7,8,9,10,11,12,23,14,0,0,0,0,8,9,10,11,12,23,14,15,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],DIAG2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,7,6,5,4,3,2,1,0,0,0,0,9,8,7,6,5,4,3,2,0,0,0,0,10,9,8,7,6,5,4,3,0,0,0,0,11,10,9,8,7,6,5,4,0,0,0,0,12,11,10,9,8,7,6,5,0,0,0,0,13,12,11,10,9,8,7,6,0,0,0,0,14,13,12,11,10,9,8,7,0,0,0,0,15,14,13,12,11,10,9,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],MAP=[];MAP.p=B_PAWN,MAP.n=B_KNIGHT,MAP.b=B_BISHOP,MAP.r=B_ROOK,MAP.q=B_QUEEN,MAP.k=B_KING,MAP.P=W_PAWN,MAP.N=W_KNIGHT,MAP.B=W_BISHOP,MAP.R=W_ROOK,MAP.Q=W_QUEEN,MAP.K=W_KING;var UMAP=[];UMAP[B_PAWN]="p",UMAP[B_KNIGHT]="n",UMAP[B_BISHOP]="b",UMAP[B_ROOK]="r",UMAP[B_QUEEN]="q",UMAP[B_KING]="k",UMAP[W_PAWN]="P",UMAP[W_KNIGHT]="N",UMAP[W_BISHOP]="B",UMAP[W_ROOK]="R",UMAP[W_QUEEN]="Q",UMAP[W_KING]="K";var STARRAY=Array(144),WKZONES=Array(144),BKZONES=Array(144),DIST=Array(144);function lozChess(){this.nodes=Array(MAX_PLY);for(var t=null,s=0;s<this.nodes.length;s++)this.nodes[s]=new lozNode(t),this.nodes[s].ply=s,t=this.nodes[s],this.nodes[s].root=0==s;this.board=new lozBoard,this.stats=new lozStats,this.uci=new lozUCI,this.rootNode=this.nodes[0];for(s=0;s<this.nodes.length;s++)this.nodes[s].board=this.board;this.board.init();for(s=0;s<this.board.b.length;s++)this.board.b[s]=EDGE;for(s=0;s<B88.length;s++)this.board.b[B88[s]]=NULL;for(s=0;s<144;s++){STARRAY[s]=Array(144);for(var i=0;i<144;i++)STARRAY[s][i]=0}for(s=0;s<B88.length;s++){var h=B88[s];for(i=0;i<KING_OFFSETS.length;i++)for(var e=KING_OFFSETS[i],S=1;S<8;S++){var _=h+S*e;if(this.board.b[_]==EDGE)break;STARRAY[h][_]=i+1}for(i=0;i<KNIGHT_OFFSETS.length;i++){_=h+(e=KNIGHT_OFFSETS[i]);this.board.b[_]!=EDGE&&(STARRAY[h][_]=-1)}}for(s=0;s<144;s++){WKZONES[s]=Array(144);for(i=0;i<144;i++)WKZONES[s][i]=0;BKZONES[s]=Array(144);for(i=0;i<144;i++)BKZONES[s][i]=0}for(s=0;s<B88.length;s++){h=B88[s];var o=WKZONES[h],r=BKZONES[h];this.board.b[h+13]||(o[h+13]=1),this.board.b[h+12]||(o[h+12]=1),this.board.b[h+11]||(o[h+11]=1),this.board.b[h-1]||(o[h-1]=1),this.board.b[h+0]||(o[h+0]=1),this.board.b[h+1]||(o[h+1]=1),this.board.b[h-11]||(o[h-11]=1),this.board.b[h-12]||(o[h-12]=1),this.board.b[h-13]||(o[h-13]=1),this.board.b[h-23]||(o[h-23]=1),this.board.b[h-24]||(o[h-24]=1),this.board.b[h-25]||(o[h-25]=1),this.board.b[h-13]||(r[h-13]=1),this.board.b[h-12]||(r[h-12]=1),this.board.b[h-11]||(r[h-11]=1),this.board.b[h-1]||(r[h-1]=1),this.board.b[h+0]||(r[h+0]=1),this.board.b[h+1]||(r[h+1]=1),this.board.b[h+11]||(r[h+11]=1),this.board.b[h+12]||(r[h+12]=1),this.board.b[h+13]||(r[h+13]=1),this.board.b[h+23]||(r[h+23]=1),this.board.b[h+24]||(r[h+24]=1),this.board.b[h+25]||(r[h+25]=1)}for(s=0;s<144;s++){DIST[s]=Array(144);var E=RANK[s],a=FILE[s];for(i=0;i<144;i++){var n=RANK[i],O=FILE[i];DIST[s][i]=Math.max(Math.abs(E-n),Math.abs(a-O))}}return this}lozChess.prototype.init=function(){for(var t=0;t<this.nodes.length;t++)this.nodes[t].init();this.board.init(),this.stats.init()},lozChess.prototype.newGameInit=function(){this.board.ttInit(),this.uci.numMoves=0},lozChess.prototype.position=function(){return this.init(),this.board.position()},lozChess.prototype.go=function(){this.stats.init(),this.stats.update();var t=this.board,s=this.uci.spec;this.uci.send("info hashfull",Math.round(1e3*t.hashUsed/TTSIZE));var i=0,h=0,e=0;if(s.depth<=0&&(s.depth=MAX_PLY),s.moveTime>0&&(this.stats.moveTime=s.moveTime),s.maxNodes>0&&(this.stats.maxNodes=s.maxNodes),0==s.moveTime){if(s.movesToGo>0)var S=s.movesToGo+2;else S=30;t.turn==WHITE?(i=s.wTime,e=s.wInc):(i=s.bTime,e=s.bInc),(h=Math.round(i/S)+e)>0&&(this.stats.moveTime=0|h),this.stats.moveTime<10&&(s.wTime||s.bTime)&&(this.stats.moveTime=10)}for(var _,o=-INFINITY,r=INFINITY,E=ASP_MAX,a=1,n=s.depth,O=0;a<=n&&(this.stats.ply=a,O=this.search(this.rootNode,a,t.turn,o,r),!this.stats.timeOut);)if(O<=o||O>=r)O>=r?this.uci.debug("BETA",a,O,">=",r):(this.uci.debug("ALPHA",a,O,"<=",o),i>3e4&&(h=h/2|0,this.stats.moveTime+=h)),o=-INFINITY,r=INFINITY,E=10*ASP_MAX;else{if(Math.abs(O)>=MINMATE&&Math.abs(O)<=MATE)break;o=O-E,r=O+E,(E-=ASP_DELTA)<ASP_MIN&&(E=ASP_MIN),a+=1}this.stats.update(),this.stats.stop(),_=t.formatMove(this.stats.bestMove,UCI_FMT),t.makeMove(this.rootNode,this.stats.bestMove),this.uci.send("bestmove",_),this.uci.debug(s.board+" "+s.turn+" "+s.rights+" "+s.ep),this.uci.debug(BUILD+" "+s.depth+"p","|",this.stats.nodesMega+"Mn","|",this.stats.nodes+"n","|",this.stats.timeSec+"s","|",_,"|",t.formatMove(this.stats.bestMove,SAN_FMT))},lozChess.prototype.search=function(t,s,i,h,e){if(!t.childNode)return this.uci.debug("S DEPTH"),void(this.stats.timeOut=1);var S=this.board,_=~i&COLOR_MASK,o=h,r=0,E=0,a=0,n=0,O=0,T=-INFINITY,A=S.isKingAttacked(_),P=0,M=0,I=INCHECK_UNKNOWN,B=s>=3;if(t.cache(),S.ttGet(t,s,h,e),A?S.genEvasions(t,i):S.genMoves(t,i),!this.stats.timeOut){for(;a=t.getNextMove();)if(S.makeMove(t,a),S.isKingAttacked(_))S.unmakeMove(t,a),t.uncache();else{if(r++,t.base<BASE_LMR&&E++,this.stats.splits>3&&this.uci.send("info currmove "+S.formatMove(a,SAN_FMT)+" currmovenumber "+r),I=INCHECK_UNKNOWN,M=0,P=0,A?M=1:B&&(I=S.isKingAttacked(i),!(t.base>=BASE_LMR||a&KEEPER_MASK||I||S.alphaMate(h))&&E>4&&(P=1+s/5+E/20|0)),1==r?O=-this.alphabeta(t.childNode,s+M-1,_,-e,-h,NULL_Y,I):(O=-this.alphabeta(t.childNode,s+M-P-1,_,-h-1,-h,NULL_Y,I),!this.stats.timeOut&&O>h&&(O=-this.alphabeta(t.childNode,s+M-1,_,-e,-h,NULL_Y,I))),S.unmakeMove(t,a),t.uncache(),this.stats.timeOut)return;if(O>T){if(O>h){if(O>=e)return t.addKiller(O,a),S.ttPut(TT_BETA,s,O,a,t.ply,h,e),S.addHistory(s,a),O;h=O,S.addHistory(s,a),this.stats.bestMove=a;var l=Math.abs(O),N="cp",u=O,d=(S.formatMove(a,S.mvFmt),S.getPVStr(t,a,s));if(l>=MINMATE&&l<=MATE){d+="#";N="mate",u=(MATE-l)/2|0;O<0&&(u=-u)}this.uci.send("info",this.stats.nodeStr(),"depth",this.stats.ply,"seldepth",this.stats.selDepth,"score",N,u,"pv",d),this.stats.update(),this.stats.splits>5&&this.uci.send("info hashfull",Math.round(1e3*S.hashUsed/TTSIZE))}T=O,n=a}}return 0==r&&this.uci.debug("INVALID"),1==r&&(this.stats.timeOut=1),T>o?(S.ttPut(TT_EXACT,s,T,n,t.ply,h,e),T):(S.ttPut(TT_ALPHA,s,o,n,t.ply,h,e),o)}},lozChess.prototype.alphabeta=function(t,s,i,h,e,S,_){if(t.childNode||(this.uci.debug("AB DEPTH"),this.stats.timeOut=1),!(s>2||this.stats.timeOut)||(this.stats.lazyUpdate(),!this.stats.timeOut)){t.ply>this.stats.selDepth&&(this.stats.selDepth=t.ply);var o,r=this.board,E=~i&COLOR_MASK,a=0,n=e!=h+1;if(r.repHi-r.repLo>100)return CONTEMPT;for(var O=r.repHi-5;O>=r.repLo;O-=2)if(r.repLoHash[O]==r.loHash&&r.repHiHash[O]==r.hiHash)return CONTEMPT;if((o=MATE-t.ply)<e&&(e=o,h>=o))return o;if((o=-MATE+t.ply)>h&&(h=o,e<=o))return o;if(s<=0)return(a=r.ttGet(t,0,h,e))!=TTSCORE_UNKNOWN?a:a=this.qSearch(t,-1,i,h,e);if((a=r.ttGet(t,s,h,e))!=TTSCORE_UNKNOWN)return a;_==INCHECK_UNKNOWN&&(_=r.isKingAttacked(E));var T=0,A=0,P=i==WHITE&&r.wCount==r.wCounts[PAWN]+1||i==BLACK&&r.bCount==r.bCounts[PAWN]+1,M=r.evaluate(i),I=(r.gPhase,!(n||_||P||S!=NULL_Y||r.betaMate(e)));if(I&&s<=2&&M-200*s>=e)return e;if(t.cache(),T=3,I&&s>2&&M>e){if(r.loHash^=r.loEP[r.ep],r.hiHash^=r.hiEP[r.ep],r.ep=0,r.loHash^=r.loEP[r.ep],r.hiHash^=r.hiEP[r.ep],r.loHash^=r.loTurn,r.hiHash^=r.hiTurn,a=-this.alphabeta(t.childNode,s-T-1,E,-e,1-e,NULL_N,INCHECK_UNKNOWN),t.uncache(),this.stats.timeOut)return;if(a>=e)return r.betaMate(a)&&(a=e),a;if(this.stats.timeOut)return}T=0;var B=-INFINITY,l=0,N=0,u=h,d=0,p=0,f=INCHECK_UNKNOWN,K=!1,H=!_&&s<=4&&M+120*s<h&&!P,W=!_&&s>=3,c=!_&&s<=2&&!P;if(!t.hashMove&&n&&s>3&&(this.alphabeta(t,s-2,i,h,e,NULL_N,_),r.ttGet(t,0,h,e)),!this.stats.timeOut&&(_?r.genEvasions(t,i):r.genMoves(t,i),!this.stats.timeOut)){for(;l=t.getNextMove();)if(r.makeMove(t,l),r.isKingAttacked(E))r.unmakeMove(t,l),t.uncache();else{if(d++,t.base<BASE_LMR&&p++,f=INCHECK_UNKNOWN,A=0,T=0,_&&s<5)A=1;else if(c||W||H){if(f=r.isKingAttacked(i),K=t.base>=BASE_LMR||l&KEEPER_MASK||f||r.alphaMate(h),c&&!K&&p>5*s){r.unmakeMove(t,l),t.uncache();continue}if(H&&!K&&d>1){r.unmakeMove(t,l),t.uncache();continue}W&&!K&&p>4&&(T=1+s/5+p/20|0)}if(n?1==d?a=-this.alphabeta(t.childNode,s+A-1,E,-e,-h,NULL_Y,f):(a=-this.alphabeta(t.childNode,s+A-T-1,E,-h-1,-h,NULL_Y,f),!this.stats.timeOut&&a>h&&(a=-this.alphabeta(t.childNode,s+A-1,E,-e,-h,NULL_Y,f))):(a=-this.alphabeta(t.childNode,s+A-T-1,E,-e,-h,NULL_Y,f),T&&!this.stats.timeOut&&a>h&&(a=-this.alphabeta(t.childNode,s+A-1,E,-e,-h,NULL_Y,f))),r.unmakeMove(t,l),t.uncache(),this.stats.timeOut)return;if(a>B){if(a>h){if(a>=e)return t.addKiller(a,l),r.ttPut(TT_BETA,s,a,l,t.ply,h,e),r.addHistory(s,l),a;r.addHistory(s,l),h=a}B=a,N=l}}return 0==d?_?(r.ttPut(TT_EXACT,s,-MATE+t.ply,0,t.ply,h,e),-MATE+t.ply):(r.ttPut(TT_EXACT,s,CONTEMPT,0,t.ply,h,e),CONTEMPT):B>u?(r.ttPut(TT_EXACT,s,B,N,t.ply,h,e),B):(r.ttPut(TT_ALPHA,s,u,N,t.ply,h,e),u)}}},lozChess.prototype.qSearch=function(t,s,i,h,e){var S=this.board,_=S.evaluate(i),o=S.gPhase,r=0,E=~i&COLOR_MASK,a=0;if(!t.childNode)return this.uci.debug("Q DEPTH"),_;if(t.ply>this.stats.selDepth&&(this.stats.selDepth=t.ply),s>-2)var n=S.isKingAttacked(E);else n=0;if(!n&&_>=e)return _;for(!n&&_>h&&(h=_),t.cache(),n?S.genEvasions(t,i):S.genQMoves(t,i);a=t.getNextMove();)if(S.makeMove(t,a),S.isKingAttacked(E))S.unmakeMove(t,a),t.uncache();else if(r++,!n&&o<=EPHASE&&!(a&MOVE_PROMOTE_MASK)&&_+200+VALUE_VECTOR[(a&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS&PIECE_MASK]<h)S.unmakeMove(t,a),t.uncache();else{var O=-this.qSearch(t.childNode,s-1,E,-e,-h);if(S.unmakeMove(t,a),t.uncache(),O>h){if(O>=e)return O;h=O}}return n&&0==r?-MATE+t.ply:h},lozChess.prototype.perft=function(){var t=this.uci.spec;this.stats.ply=t.depth;var s=this.perftSearch(this.rootNode,t.depth,this.board.turn,t.inner);this.stats.update();var i=s-t.moves;if(0==i)var h="";else h="ERROR "+i;this.uci.send("info string",t.id,t.depth,s,t.moves,h,this.board.fen())},lozChess.prototype.perftSearch=function(t,s,i,h){if(0==s)return 1;var e=this.board,S=0,_=0,o=0,r=~i&COLOR_MASK,E=0,a=e.isKingAttacked(r);for(t.cache(),a?e.genEvasions(t,i):e.genMoves(t,i);o=t.getNextMove();){if(e.makeMove(t,o),e.isKingAttacked(r))e.unmakeMove(t,o),t.uncache();else if(E++,_+=S=this.perftSearch(t.childNode,s-1,r),e.unmakeMove(t,o),t.uncache(),t.root){var n=e.formatMove(o,SAN_FMT);this.uci.send("info currmove "+n+" currmovenumber "+E),h&&this.uci.send("info string",n,S)}}return s>2&&this.stats.lazyUpdate(),_};const TTSIZE=1<<24,TTMASK=TTSIZE-1,PTTSIZE=16384,PTTMASK=PTTSIZE-1;function lozBoard(){this.initNumWhitePieces=0,this.initNumBlackPieces=0,this.initNumWhitePawns=0,this.initNumBlackPawns=0,this.lozza=null,this.verbose=!1,this.mvFmt=0,this.hashUsed=0,this.b=new Uint16Array(144),this.z=new Uint16Array(144),this.wList=new Uint16Array(16),this.bList=new Uint16Array(16),this.firstBP=0,this.firstWP=0,this.runningEvalS=0,this.runningEvalE=0,this.rights=0,this.ep=0,this.repLo=0,this.repHi=0,this.loHash=0,this.hiHash=0,this.ploHash=0,this.phiHash=0,this.ttLo=new Int32Array(TTSIZE),this.ttHi=new Int32Array(TTSIZE),this.ttType=new Uint8Array(TTSIZE),this.ttDepth=new Int8Array(TTSIZE),this.ttMove=new Uint32Array(TTSIZE),this.ttScore=new Int16Array(TTSIZE),this.pttLo=new Int32Array(PTTSIZE),this.pttHi=new Int32Array(PTTSIZE),this.pttFlags=new Uint8Array(PTTSIZE),this.pttScoreS=new Int16Array(PTTSIZE),this.pttScoreE=new Int16Array(PTTSIZE),this.pttwLeast=new Uint32Array(PTTSIZE),this.pttbLeast=new Uint32Array(PTTSIZE),this.pttwMost=new Uint32Array(PTTSIZE),this.pttbMost=new Uint32Array(PTTSIZE),this.ttInit(),this.turn=0,this.loTurn=this.rand32(),this.hiTurn=this.rand32(),this.loPieces=Array(2);for(var t=0;t<2;t++){this.loPieces[t]=Array(6);for(var s=0;s<6;s++){this.loPieces[t][s]=new Array(144);for(var i=0;i<144;i++)this.loPieces[t][s][i]=this.rand32()}}this.hiPieces=Array(2);for(t=0;t<2;t++){this.hiPieces[t]=Array(6);for(s=0;s<6;s++){this.hiPieces[t][s]=new Array(144);for(i=0;i<144;i++)this.hiPieces[t][s][i]=this.rand32()}}this.loRights=new Array(16),this.hiRights=new Array(16);for(t=0;t<16;t++)this.loRights[t]=this.rand32(),this.hiRights[t]=this.rand32();this.loEP=new Array(144),this.hiEP=new Array(144);for(t=0;t<144;t++)this.loEP[t]=this.rand32(),this.hiEP[t]=this.rand32();this.repLoHash=new Array(1e3);for(t=0;t<1e3;t++)this.repLoHash[t]=0;this.repHiHash=new Array(1e3);for(t=0;t<1e3;t++)this.repHiHash[t]=0;this.phase=TPHASE,this.gPhase=0,this.wCounts=new Uint16Array(7),this.bCounts=new Uint16Array(7),this.wCount=0,this.bCount=0,this.wHistory=Array(7);for(t=0;t<7;t++){this.wHistory[t]=Array(144);for(s=0;s<144;s++)this.wHistory[t][s]=0}this.bHistory=Array(7);for(t=0;t<7;t++){this.bHistory[t]=Array(144);for(s=0;s<144;s++)this.bHistory[t][s]=0}}lozBoard.prototype.init=function(){this.initNumWhitePieces=0,this.initNumBlackPieces=0,this.initNumWhitePawns=0,this.initNumBlackPawns=0;for(var t=0;t<this.b.length;t++)this.b[t]=EDGE;for(t=0;t<B88.length;t++)this.b[B88[t]]=NULL;for(t=0;t<this.z.length;t++)this.z[t]=NO_Z;this.loHash=0,this.hiHash=0,this.ploHash=0,this.phiHash=0,this.repLo=0,this.repHi=0,this.phase=TPHASE,this.gPhase=0;for(t=0;t<this.wCounts.length;t++)this.wCounts[t]=0;for(t=0;t<this.bCounts.length;t++)this.bCounts[t]=0;this.wCount=0,this.bCount=0;for(t=0;t<this.wList.length;t++)this.wList[t]=EMPTY;for(t=0;t<this.bList.length;t++)this.bList[t]=EMPTY;this.firstBP=0,this.firstWP=0,this.mvFmt=lozzaHost==HOST_WEB?SAN_FMT:UCI_FMT},lozBoard.prototype.position=function(){var t=lozza.uci.spec;this.initNumWhitePieces=0,this.initNumBlackPieces=0,this.initNumWhitePawns=0,this.initNumBlackPawns=0,"w"==t.turn?this.turn=WHITE:(this.turn=BLACK,this.loHash^=this.loTurn,this.hiHash^=this.hiTurn),this.rights=0;for(var s=0;s<t.rights.length;s++){"K"==(_=t.rights.charAt(s))&&(this.rights|=WHITE_RIGHTS_KING),"Q"==_&&(this.rights|=WHITE_RIGHTS_QUEEN),"k"==_&&(this.rights|=BLACK_RIGHTS_KING),"q"==_&&(this.rights|=BLACK_RIGHTS_QUEEN)}this.loHash^=this.loRights[this.rights],this.hiHash^=this.hiRights[this.rights],this.phase=TPHASE;for(var i=0,h=0,e=0,S=0;S<t.board.length;S++){for(var _=t.board.charAt(S),o=parseInt(_);this.b[i]==EDGE;)i++;if(isNaN(o)){if("/"!=_){var r=MAP[_],E=r&PIECE_MASK,a=r&COLOR_MASK;a==WHITE?(this.wList[h]=i,this.b[i]=r,this.z[i]=h,h++,this.wCounts[E]++,this.wCount++):(this.bList[e]=i,this.b[i]=r,this.z[i]=e,e++,this.bCounts[E]++,this.bCount++),this.loHash^=this.loPieces[a>>>3][E-1][i],this.hiHash^=this.hiPieces[a>>>3][E-1][i],E==PAWN&&(this.ploHash^=this.loPieces[a>>>3][0][i],this.phiHash^=this.hiPieces[a>>>3][0][i]),this.phase-=VPHASE[E],i++}}else for(var n=0;n<o;n++)this.b[i]=NULL,i++}2==t.ep.length?this.ep=COORDS.indexOf(t.ep):this.ep=0,this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep],this.runningEvalS=0,this.runningEvalE=0;for(var O=0,T=0;T<this.wCount;)if(i=this.wList[O]){E=this.b[i]&PIECE_MASK;this.runningEvalS+=VALUE_VECTOR[E],this.runningEvalS+=WS_PST[E][i],this.runningEvalE+=VALUE_VECTOR[E],this.runningEvalE+=WE_PST[E][i],T++,O++}else O++;for(O=0,T=0;T<this.bCount;)if(i=this.bList[O]){E=this.b[i]&PIECE_MASK;this.runningEvalS-=VALUE_VECTOR[E],this.runningEvalS-=BS_PST[E][i],this.runningEvalE-=VALUE_VECTOR[E],this.runningEvalE-=BE_PST[E][i],T++,O++}else O++;this.compact();for(s=0;s<t.moves.length;s++)if(!this.playMove(t.moves[s]))return 0;this.initNumWhitePawns=this.wCounts[PAWN],this.initNumWhitePieces=this.wCount-this.initNumWhitePawns,this.initNumBlackPawns=this.bCounts[PAWN],this.initNumBlackPieces=this.bCount-this.initNumBlackPawns,this.compact();for(s=0;s<7;s++)for(S=0;S<144;S++)this.wHistory[s][S]=0;for(s=0;s<7;s++)for(S=0;S<144;S++)this.bHistory[s][S]=0;return 1},lozBoard.prototype.compact=function(){for(var t=[],s=0;s<16;s++)this.wList[s]&&t.push(this.wList[s]);t.sort(function(t,s){return lozza.board.b[s]-lozza.board.b[t]});for(s=0;s<16;s++)s<t.length?(this.wList[s]=t[s],this.z[t[s]]=s):this.wList[s]=EMPTY;this.firstWP=0;for(s=0;s<16;s++)if(this.b[this.wList[s]]==W_PAWN){this.firstWP=s;break}this.b[this.wList[0]]!=W_KING&&console.log("WHITE INDEX ERR");for(t=[],s=0;s<16;s++)this.bList[s]&&t.push(this.bList[s]);t.sort(function(t,s){return lozza.board.b[s]-lozza.board.b[t]});for(s=0;s<16;s++)s<t.length?(this.bList[s]=t[s],this.z[t[s]]=s):this.bList[s]=EMPTY;this.firstBP=0;for(s=0;s<16;s++)if(this.b[this.bList[s]]==B_PAWN){this.firstBP=s;break}this.b[this.bList[0]]!=B_KING&&console.log("BLACK INDEX ERR")},lozBoard.prototype.genMoves=function(t,s){t.numMoves=0,t.sortedIndex=0;var i=this.b;if(s==WHITE){var h=WP_OFFSET_ORTH,e=WP_OFFSET_DIAG1,S=WP_OFFSET_DIAG2,_=2,o=7,r=this.rights&WHITE_RIGHTS,E=this.wList,a=this.wCount,n=IS_B;r&&(r&WHITE_RIGHTS_KING&&i[F1]==NULL&&i[G1]==NULL&&!this.isAttacked(F1,BLACK)&&!this.isAttacked(E1,BLACK)&&t.addCastle(MOVE_E1G1),r&WHITE_RIGHTS_QUEEN&&i[B1]==NULL&&i[C1]==NULL&&i[D1]==NULL&&!this.isAttacked(D1,BLACK)&&!this.isAttacked(E1,BLACK)&&t.addCastle(MOVE_E1C1))}else{h=BP_OFFSET_ORTH,e=BP_OFFSET_DIAG1,S=BP_OFFSET_DIAG2,_=7,o=2,r=this.rights&BLACK_RIGHTS,E=this.bList,a=this.bCount,n=IS_W;r&&(r&BLACK_RIGHTS_KING&&i[F8]==NULL&&i[G8]==NULL&&!this.isAttacked(F8,WHITE)&&!this.isAttacked(E8,WHITE)&&t.addCastle(MOVE_E8G8),r&BLACK_RIGHTS_QUEEN&&i[B8]==NULL&&i[C8]==NULL&&i[D8]==NULL&&!this.isAttacked(D8,WHITE)&&!this.isAttacked(E8,WHITE)&&t.addCastle(MOVE_E8C8))}for(var O=0,T=0,A=0,P=0,M=0,I=0,B=0,l=0,N=0;T<a;)if(M=E[O]){if(B=(I=i[M])&PIECE_MASK,l=I<<MOVE_FROBJ_BITS|M<<MOVE_FR_BITS,N=RANK[M],B==PAWN)l|=MOVE_PAWN_MASK,(P=i[A=M+h])||(N==o?t.addPromotion(l|A):(t.addSlide(l|A),N==_&&(i[A+=h]||t.addSlide(l|A|MOVE_EPMAKE_MASK)))),n[P=i[A=M+e]]?N==o?t.addPromotion(l|P<<MOVE_TOOBJ_BITS|A):t.addCapture(l|P<<MOVE_TOOBJ_BITS|A):P||A!=this.ep||t.addEPTake(l|P<<MOVE_TOOBJ_BITS|A),n[P=i[A=M+S]]?N==o?t.addPromotion(l|P<<MOVE_TOOBJ_BITS|A):t.addCapture(l|P<<MOVE_TOOBJ_BITS|A):P||A!=this.ep||t.addEPTake(l|A);else if(IS_KN[I])for(var u=OFFSETS[B],d=0;d<8;)(P=i[A=M+u[d++]])?n[P]&&t.addCapture(l|P<<MOVE_TOOBJ_BITS|A):t.addSlide(l|A);else{var p=(u=OFFSETS[B]).length;for(d=0;d<p;){var f=u[d++];for(P=i[A=M+f];!P;)t.addSlide(l|A),P=i[A+=f];n[P]&&t.addCapture(l|P<<MOVE_TOOBJ_BITS|A)}}O++,T++}else O++},lozBoard.prototype.genEvasions=function(t,s){t.numMoves=0,t.sortedIndex=0;var i=this.b;if(s==WHITE)var h=WP_OFFSET_ORTH,e=WP_OFFSET_DIAG1,S=WP_OFFSET_DIAG2,_=2,o=8,r=this.wList,E=this.wCount,a=STARRAY[this.wList[0]],n=W_KING;else h=BP_OFFSET_ORTH,e=BP_OFFSET_DIAG1,S=BP_OFFSET_DIAG2,_=7,o=1,r=this.bList,E=this.bCount,a=STARRAY[this.bList[0]],n=B_KING;for(var O=0,T=0;T<E;){var A=r[O];if(A){var P=this.b[A],M=P&PIECE_MASK,I=P<<MOVE_FROBJ_BITS|A<<MOVE_FR_BITS,B=a[A];if(M==PAWN){I|=MOVE_PAWN_MASK;var l=i[W=A+h],N=(u=a[W])>0&&u!=B&&!CORNERS[W];l==NULL&&(RANK[W]==o&&N?t.addPromotion(I|l<<MOVE_TOOBJ_BITS|W):(N&&t.addSlide(I|l<<MOVE_TOOBJ_BITS|W),RANK[A]==_&&(l=i[W+=h],N=(u=a[W])>0&&u!=B&&!CORNERS[W],l==NULL&&N&&t.addSlide(I|l<<MOVE_TOOBJ_BITS|W|MOVE_EPMAKE_MASK))));l=i[W=A+e];var u=a[W];l!=NULL&&l!=EDGE&&(l&COLOR_MASK)!=s&&u?RANK[W]==o?t.addPromotion(I|l<<MOVE_TOOBJ_BITS|W):t.addCapture(I|l<<MOVE_TOOBJ_BITS|W):l==NULL&&W==this.ep&&u&&t.addEPTake(I|l<<MOVE_TOOBJ_BITS|W);l=i[W=A+S],u=a[W];l!=NULL&&l!=EDGE&&(l&COLOR_MASK)!=s&&u?RANK[W]==o?t.addPromotion(I|l<<MOVE_TOOBJ_BITS|W):t.addCapture(I|l<<MOVE_TOOBJ_BITS|W):l==NULL&&W==this.ep&&u&&t.addEPTake(I|l<<MOVE_TOOBJ_BITS|W)}else for(var d=OFFSETS[M],p=LIMITS[M],f=0;f<d.length;f++)for(var K=d[f],H=1;H<=p;H++){var W;l=i[W=A+K*H],u=a[W];if(l!=NULL){if(l==EDGE)break;(l&COLOR_MASK)!=s&&u&&t.addCapture(I|l<<MOVE_TOOBJ_BITS|W);break}(P==n||u>0&&u!=B&&!CORNERS[W])&&t.addSlide(I|l<<MOVE_TOOBJ_BITS|W)}O++,T++}else O++}},lozBoard.prototype.genQMoves=function(t,s){t.numMoves=0,t.sortedIndex=0;var i=this.b;if(s==WHITE)var h=WP_OFFSET_ORTH,e=WP_OFFSET_DIAG1,S=WP_OFFSET_DIAG2,_=7,o=this.wList,r=this.wCount,E=IS_B;else h=BP_OFFSET_ORTH,e=BP_OFFSET_DIAG1,S=BP_OFFSET_DIAG2,_=2,o=this.bList,r=this.bCount,E=IS_W;for(var a=0,n=0,O=0,T=0,A=0,P=0,M=0,I=0,B=0;n<r;)if(A=o[a]){if(M=(P=i[A])&PIECE_MASK,I=P<<MOVE_FROBJ_BITS|A<<MOVE_FR_BITS,B=RANK[A],M==PAWN)I|=MOVE_PAWN_MASK,(T=i[O=A+h])||B==_&&t.addQPromotion(MOVE_PROMOTE_MASK|I|O),E[T=i[O=A+e]]?B==_?t.addQPromotion(MOVE_PROMOTE_MASK|I|T<<MOVE_TOOBJ_BITS|O):t.addQMove(I|T<<MOVE_TOOBJ_BITS|O):T||O!=this.ep||t.addQMove(MOVE_EPTAKE_MASK|I|O),E[T=i[O=A+S]]?B==_?t.addQPromotion(MOVE_PROMOTE_MASK|I|T<<MOVE_TOOBJ_BITS|O):t.addQMove(I|T<<MOVE_TOOBJ_BITS|O):T||O!=this.ep||t.addQMove(MOVE_EPTAKE_MASK|I|O);else if(IS_KN[P])for(var l=OFFSETS[M],N=0;N<8;)E[T=i[O=A+l[N++]]]&&t.addQMove(I|T<<MOVE_TOOBJ_BITS|O);else{var u=(l=OFFSETS[M]).length;for(N=0;N<u;){var d=l[N++];for(O=A+d;!i[O];)O+=d;E[T=i[O]]&&t.addQMove(I|T<<MOVE_TOOBJ_BITS|O)}}a++,n++}else a++},lozBoard.prototype.makeMove=function(t,s){this.lozza.stats.nodes++;var i=this.b,h=this.z,e=(s&MOVE_FR_MASK)>>>MOVE_FR_BITS,S=(s&MOVE_TO_MASK)>>>MOVE_TO_BITS,_=(s&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS,o=(s&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS,r=o&PIECE_MASK,E=o&COLOR_MASK,a=E>>>3;if(i[e]=NULL,i[S]=o,t.frZ=h[e],t.toZ=h[S],h[e]=NO_Z,h[S]=t.frZ,this.loHash^=this.loPieces[a][r-1][e],this.hiHash^=this.hiPieces[a][r-1][e],this.loHash^=this.loPieces[a][r-1][S],this.hiHash^=this.hiPieces[a][r-1][S],r==PAWN&&(this.ploHash^=this.loPieces[a][PAWN-1][e],this.phiHash^=this.hiPieces[a][PAWN-1][e],this.ploHash^=this.loPieces[a][PAWN-1][S],this.phiHash^=this.hiPieces[a][PAWN-1][S]),E==WHITE?(this.wList[t.frZ]=S,this.runningEvalS-=WS_PST[r][e],this.runningEvalS+=WS_PST[r][S],this.runningEvalE-=WE_PST[r][e],this.runningEvalE+=WE_PST[r][S]):(this.bList[t.frZ]=S,this.runningEvalS+=BS_PST[r][e],this.runningEvalS-=BS_PST[r][S],this.runningEvalE+=BE_PST[r][e],this.runningEvalE-=BE_PST[r][S]),this.rights&&(this.loHash^=this.loRights[this.rights],this.hiHash^=this.hiRights[this.rights],this.rights&=MASK_RIGHTS[e]&MASK_RIGHTS[S],this.loHash^=this.loRights[this.rights],this.hiHash^=this.hiRights[this.rights]),_){var n=_&PIECE_MASK,O=_&COLOR_MASK,T=O>>>3;this.loHash^=this.loPieces[T][n-1][S],this.hiHash^=this.hiPieces[T][n-1][S],n==PAWN&&(this.ploHash^=this.loPieces[T][PAWN-1][S],this.phiHash^=this.hiPieces[T][PAWN-1][S]),this.phase+=VPHASE[n],O==WHITE?(this.wList[t.toZ]=EMPTY,this.runningEvalS-=VALUE_VECTOR[n],this.runningEvalS-=WS_PST[n][S],this.runningEvalE-=VALUE_VECTOR[n],this.runningEvalE-=WE_PST[n][S],this.wCounts[n]--,this.wCount--):(this.bList[t.toZ]=EMPTY,this.runningEvalS+=VALUE_VECTOR[n],this.runningEvalS+=BS_PST[n][S],this.runningEvalE+=VALUE_VECTOR[n],this.runningEvalE+=BE_PST[n][S],this.bCounts[n]--,this.bCount--)}if(this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep],this.ep=0,this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep],s&MOVE_SPECIAL_MASK)if(E==WHITE){var A=S+12;if(s&MOVE_EPMAKE_MASK)this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep],this.ep=A,this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep];else if(s&MOVE_EPTAKE_MASK)i[A]=NULL,t.epZ=h[A],h[A]=NO_Z,this.bList[t.epZ]=EMPTY,this.loHash^=this.loPieces[I_BLACK][PAWN-1][A],this.hiHash^=this.hiPieces[I_BLACK][PAWN-1][A],this.ploHash^=this.loPieces[I_BLACK][PAWN-1][A],this.phiHash^=this.hiPieces[I_BLACK][PAWN-1][A],this.runningEvalS+=VALUE_PAWN,this.runningEvalS+=BS_PST[PAWN][A],this.runningEvalE+=VALUE_PAWN,this.runningEvalE+=BE_PST[PAWN][A],this.bCounts[PAWN]--,this.bCount--;else if(s&MOVE_PROMOTE_MASK){var P=2+((s&MOVE_PROMAS_MASK)>>>MOVE_PROMAS_BITS);i[S]=WHITE|P,this.loHash^=this.loPieces[I_WHITE][PAWN-1][S],this.hiHash^=this.hiPieces[I_WHITE][PAWN-1][S],this.loHash^=this.loPieces[I_WHITE][P-1][S],this.hiHash^=this.hiPieces[I_WHITE][P-1][S],this.ploHash^=this.loPieces[0][PAWN-1][S],this.phiHash^=this.hiPieces[0][PAWN-1][S],this.runningEvalS-=VALUE_PAWN,this.runningEvalS-=WS_PST[PAWN][S],this.runningEvalE-=VALUE_PAWN,this.runningEvalE-=WE_PST[PAWN][S],this.wCounts[PAWN]--,this.runningEvalS+=VALUE_VECTOR[P],this.runningEvalS+=WS_PST[P][S],this.runningEvalE+=VALUE_VECTOR[P],this.runningEvalE+=WE_PST[P][S],this.wCounts[P]++,this.phase-=VPHASE[P]}else s==MOVE_E1G1?(i[H1]=NULL,i[F1]=W_ROOK,h[F1]=h[H1],h[H1]=NO_Z,this.wList[h[F1]]=F1,this.loHash^=this.loPieces[I_WHITE][ROOK-1][H1],this.hiHash^=this.hiPieces[I_WHITE][ROOK-1][H1],this.loHash^=this.loPieces[I_WHITE][ROOK-1][F1],this.hiHash^=this.hiPieces[I_WHITE][ROOK-1][F1],this.runningEvalS-=WS_PST[ROOK][H1],this.runningEvalS+=WS_PST[ROOK][F1],this.runningEvalE-=WE_PST[ROOK][H1],this.runningEvalE+=WE_PST[ROOK][F1]):s==MOVE_E1C1&&(i[A1]=NULL,i[D1]=W_ROOK,h[D1]=h[A1],h[A1]=NO_Z,this.wList[h[D1]]=D1,this.loHash^=this.loPieces[I_WHITE][ROOK-1][A1],this.hiHash^=this.hiPieces[I_WHITE][ROOK-1][A1],this.loHash^=this.loPieces[I_WHITE][ROOK-1][D1],this.hiHash^=this.hiPieces[I_WHITE][ROOK-1][D1],this.runningEvalS-=WS_PST[ROOK][A1],this.runningEvalS+=WS_PST[ROOK][D1],this.runningEvalE-=WE_PST[ROOK][A1],this.runningEvalE+=WE_PST[ROOK][D1])}else{A=S-12;if(s&MOVE_EPMAKE_MASK)this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep],this.ep=A,this.loHash^=this.loEP[this.ep],this.hiHash^=this.hiEP[this.ep];else if(s&MOVE_EPTAKE_MASK)i[A]=NULL,t.epZ=h[A],h[A]=NO_Z,this.wList[t.epZ]=EMPTY,this.loHash^=this.loPieces[I_WHITE][PAWN-1][A],this.hiHash^=this.hiPieces[I_WHITE][PAWN-1][A],this.ploHash^=this.loPieces[I_WHITE][PAWN-1][A],this.phiHash^=this.hiPieces[I_WHITE][PAWN-1][A],this.runningEvalS-=VALUE_PAWN,this.runningEvalS-=WS_PST[PAWN][A],this.runningEvalE-=VALUE_PAWN,this.runningEvalE-=WE_PST[PAWN][A],this.wCounts[PAWN]--,this.wCount--;else if(s&MOVE_PROMOTE_MASK){P=2+((s&MOVE_PROMAS_MASK)>>>MOVE_PROMAS_BITS);i[S]=BLACK|P,this.loHash^=this.loPieces[I_BLACK][PAWN-1][S],this.hiHash^=this.hiPieces[I_BLACK][PAWN-1][S],this.loHash^=this.loPieces[I_BLACK][P-1][S],this.hiHash^=this.hiPieces[I_BLACK][P-1][S],this.ploHash^=this.loPieces[I_BLACK][PAWN-1][S],this.phiHash^=this.hiPieces[I_BLACK][PAWN-1][S],this.runningEvalS+=VALUE_PAWN,this.runningEvalS+=BS_PST[PAWN][S],this.runningEvalE+=VALUE_PAWN,this.runningEvalE+=BE_PST[PAWN][S],this.bCounts[PAWN]--,this.runningEvalS-=VALUE_VECTOR[P],this.runningEvalS-=BS_PST[P][S],this.runningEvalE-=VALUE_VECTOR[P],this.runningEvalE-=BE_PST[P][S],this.bCounts[P]++,this.phase-=VPHASE[P]}else s==MOVE_E8G8?(i[H8]=NULL,i[F8]=B_ROOK,h[F8]=h[H8],h[H8]=NO_Z,this.bList[h[F8]]=F8,this.loHash^=this.loPieces[I_BLACK][ROOK-1][H8],this.hiHash^=this.hiPieces[I_BLACK][ROOK-1][H8],this.loHash^=this.loPieces[I_BLACK][ROOK-1][F8],this.hiHash^=this.hiPieces[I_BLACK][ROOK-1][F8],this.runningEvalS+=BS_PST[ROOK][H8],this.runningEvalS-=BS_PST[ROOK][F8],this.runningEvalE+=BE_PST[ROOK][H8],this.runningEvalE-=BE_PST[ROOK][F8]):s==MOVE_E8C8&&(i[A8]=NULL,i[D8]=B_ROOK,h[D8]=h[A8],h[A8]=NO_Z,this.bList[h[D8]]=D8,this.loHash^=this.loPieces[I_BLACK][ROOK-1][A8],this.hiHash^=this.hiPieces[I_BLACK][ROOK-1][A8],this.loHash^=this.loPieces[I_BLACK][ROOK-1][D8],this.hiHash^=this.hiPieces[I_BLACK][ROOK-1][D8],this.runningEvalS+=BS_PST[ROOK][A8],this.runningEvalS-=BS_PST[ROOK][D8],this.runningEvalE+=BE_PST[ROOK][A8],this.runningEvalE-=BE_PST[ROOK][D8])}this.loHash^=this.loTurn,this.hiHash^=this.hiTurn,this.repLoHash[this.repHi]=this.loHash,this.repHiHash[this.repHi]=this.hiHash,this.repHi++,(s&(MOVE_SPECIAL_MASK|MOVE_TOOBJ_MASK)||r==PAWN)&&(this.repLo=this.repHi)},lozBoard.prototype.unmakeMove=function(t,s){var i=this.b,h=this.z,e=(s&MOVE_FR_MASK)>>>MOVE_FR_BITS,S=(s&MOVE_TO_MASK)>>>MOVE_TO_BITS,_=(s&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS,o=(s&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS,r=o&COLOR_MASK;if(i[e]=o,i[S]=_,h[e]=t.frZ,h[S]=t.toZ,r==WHITE?this.wList[t.frZ]=e:this.bList[t.frZ]=e,_){var E=_&PIECE_MASK,a=_&COLOR_MASK;this.phase-=VPHASE[E],a==WHITE?(this.wList[t.toZ]=S,this.wCounts[E]++,this.wCount++):(this.bList[t.toZ]=S,this.bCounts[E]++,this.bCount++)}if(s&MOVE_SPECIAL_MASK)if((o&COLOR_MASK)==WHITE){var n=S+12;if(s&MOVE_EPTAKE_MASK)i[n]=B_PAWN,h[n]=t.epZ,this.bList[t.epZ]=n,this.bCounts[PAWN]++,this.bCount++;else if(s&MOVE_PROMOTE_MASK){var O=2+((s&MOVE_PROMAS_MASK)>>>MOVE_PROMAS_BITS);this.wCounts[PAWN]++,this.wCounts[O]--,this.phase+=VPHASE[O]}else s==MOVE_E1G1?(i[H1]=W_ROOK,i[F1]=NULL,h[H1]=h[F1],h[F1]=NO_Z,this.wList[h[H1]]=H1):s==MOVE_E1C1&&(i[A1]=W_ROOK,i[D1]=NULL,h[A1]=h[D1],h[D1]=NO_Z,this.wList[h[A1]]=A1)}else{n=S-12;if(s&MOVE_EPTAKE_MASK)i[n]=W_PAWN,h[n]=t.epZ,this.wList[t.epZ]=n,this.wCounts[PAWN]++,this.wCount++;else if(s&MOVE_PROMOTE_MASK){O=2+((s&MOVE_PROMAS_MASK)>>>MOVE_PROMAS_BITS);this.bCounts[PAWN]++,this.bCounts[O]--,this.phase+=VPHASE[O]}else s==MOVE_E8G8?(i[H8]=B_ROOK,i[F8]=NULL,h[H8]=h[F8],h[F8]=NO_Z,this.bList[h[H8]]=H8):s==MOVE_E8C8&&(i[A8]=B_ROOK,i[D8]=NULL,h[A8]=h[D8],h[D8]=NO_Z,this.bList[h[A8]]=A8)}},lozBoard.prototype.isKingAttacked=function(t){return this.isAttacked(t==WHITE?this.bList[0]:this.wList[0],t)},lozBoard.prototype.isAttacked=function(t,s){var i=this.b,h=0;if(s==WHITE){if(i[t+13]==W_PAWN||i[t+11]==W_PAWN)return 1;var e=IS_WRQ,S=IS_WBQ}else{if(i[t-13]==B_PAWN||i[t-11]==B_PAWN)return 1;e=IS_BRQ,S=IS_BBQ}var _=KNIGHT|s,o=KING|s;if(i[t+-10]==_)return 1;if(i[t+-23]==_)return 1;if(i[t+-14]==_)return 1;if(i[t+-25]==_)return 1;if(i[t+10]==_)return 1;if(i[t+23]==_)return 1;if(i[t+14]==_)return 1;if(i[t+25]==_)return 1;for(h=t+1;!i[h];)h+=1;if(e[i[h]])return 1;for(h=t-1;!i[h];)h-=1;if(e[i[h]])return 1;for(h=t+12;!i[h];)h+=12;if(e[i[h]])return 1;for(h=t-12;!i[h];)h-=12;if(e[i[h]])return 1;for(h=t+11;!i[h];)h+=11;if(S[i[h]])return 1;for(h=t-11;!i[h];)h-=11;if(S[i[h]])return 1;for(h=t+13;!i[h];)h+=13;if(S[i[h]])return 1;for(h=t-13;!i[h];)h-=13;return S[i[h]]?1:i[t+-11]==o?1:i[t+-13]==o?1:i[t+-12]==o?1:i[t+-1]==o?1:i[t+11]==o?1:i[t+13]==o?1:i[t+12]==o?1:i[t+1]==o?1:0},lozBoard.prototype.formatMove=function(t,s){if(0==t)return"NULL";var i=(t&MOVE_TO_MASK)>>>MOVE_TO_BITS,h=(t&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS,e=(t&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS,S=COORDS[(t&MOVE_FR_MASK)>>>MOVE_FR_BITS],_=COORDS[i],o=e&PIECE_MASK,r=NAMES[o];NAMES[h&PIECE_MASK];if(t&MOVE_PROMOTE_MASK)var E=PROMOTES[(t&MOVE_PROMAS_MASK)>>>MOVE_PROMAS_BITS];else E="";return s==UCI_FMT?S+_+E:(E&&(E="="+E.toUpperCase()),h!=NULL?o==PAWN?S+"x"+_+E:r+"x"+_:o==PAWN?_+E:t==MOVE_E1G1||t==MOVE_E8G8?"O-O":t==MOVE_E1C1||t==MOVE_E8C8?"O-O-O":r+_)};var MOB_NS=4,MOB_NE=4,MOB_BS=5,MOB_BE=5,MOB_RS=2,MOB_RE=4,MOB_QS=1,MOB_QE=2,MOB_NIS=IS_NBRQKE,MOB_BIS=IS_NBRQKE,MOB_RIS=IS_RQKE,MOB_QIS=IS_QKE,ATT_N=1,ATT_B=1,ATT_R=3,ATT_Q=4,ATT_W=[0,0,.5,.75,.88,.94,.97,.99],ATT_L=7,ATT_M=20,WSHELTER=new Uint32Array([0,0,0,11,20,27,32,35,0,36]),BSHELTER=new Uint32Array([36,0,35,32,27,20,11,0,0,0]),WSTORM=new Uint32Array([0,0,0,60,30,10,0,0,0,0]),BSTORM=new Uint32Array([0,0,0,0,10,30,60,0,0,0]),PTT_EXACT=1,PTT_WHOME=2,PTT_BHOME=4,PTT_WPASS=8,PTT_BPASS=16,PAWN_DOUBLED_S=10,PAWN_DOUBLED_E=20,PAWN_ISOLATED_S=10,PAWN_ISOLATED_E=20,PAWN_BACKWARD_S=8,PAWN_BACKWARD_E=10,PAWN_PASSED=[0,0,0,0,.1,.3,.6,1,0],W_PROMOTE_SQ=[0,26,27,28,29,30,31,32,33],B_PROMOTE_SQ=[0,110,111,112,113,114,115,116,117];lozBoard.prototype.evaluate=function(t){var s=this.lozza.uci,i=this.b,h=this.phase;h<0&&(h=0),h>TPHASE&&(h=TPHASE),this.gPhase=(h<<8)/TPHASE+.5|0;var e=this.wCount+this.bCount,S=this.wCounts[QUEEN],_=this.wCounts[ROOK],o=this.wCounts[BISHOP],r=this.wCounts[KNIGHT],E=this.wCounts[PAWN],a=this.bCounts[QUEEN],n=this.bCounts[ROOK],O=this.bCounts[BISHOP],T=this.bCounts[KNIGHT],A=this.bCounts[PAWN],P=this.wList[0],M=RANK[P],I=FILE[P],B=this.bList[0],l=RANK[B],N=FILE[B],u=I-1<<2,d=15<<u,p=N-1<<2,f=15<<p,K=0,H=WKZONES[P],W=BKZONES[B],c=a&&(n||O||T),R=S&&(_||o||r);if(2==e)return CONTEMPT;if(3==e&&(r||o||T||O))return CONTEMPT;if(4==e&&(r||o)&&(T||O))return CONTEMPT;if(4==e&&(2==r||2==T))return CONTEMPT;if(5==e&&2==r&&(T||O))return CONTEMPT;if(5==e&&2==T&&(r||o))return CONTEMPT;if(5==e&&2==o&&O)return CONTEMPT;if(5==e&&2==O&&o)return CONTEMPT;if(4==e&&_&&n)return CONTEMPT;if(4==e&&S&&a)return CONTEMPT;var L=0,v=0,C=0,g=0,b=0,m=0,Q=2576980377,V=0,U=0,G=2576980377,F=0,k=0,y=0,D=0,z=0,w=0,J=0,Z=0,Y=this.ploHash&PTTMASK,x=this.pttFlags[Y];if(x&PTT_EXACT&&this.pttLo[Y]==this.ploHash&&this.pttHi[Y]==this.phiHash)L=this.pttScoreS[Y],v=this.pttScoreE[Y],Q=this.pttwLeast[Y],V=this.pttbLeast[Y],U=this.pttwMost[Y],G=this.pttbMost[Y],b=x&PTT_WHOME,m=x&PTT_BHOME,C=x&PTT_WPASS,g=x&PTT_BPASS,z=Q>>>4|2415919104,F=Q<<4|9,J=U>>>4,y=U<<4,w=V>>>4,k=V<<4,Z=G>>>4|2415919104,D=G<<4|9;else{for(var X=this.firstWP,q=0;q<E;){if((at=this.wList[X])&&i[at]==W_PAWN){var j=RANK[at];9!=(tt=(Q&($=15<<(Ot=(nt=FILE[at])-1<<2)))>>>Ot)&&(L-=PAWN_DOUBLED_S,v-=PAWN_DOUBLED_E),j<tt&&(Q=Q&~$|j<<Ot),j>(U&$)>>>Ot&&(U=U&~$|j<<Ot),2==j&&(b=PTT_WHOME),q++,X++}else X++}z=Q>>>4|2415919104,F=Q<<4|9,J=U>>>4,y=U<<4;for(X=this.firstBP,q=0;q<A;){if((at=this.bList[X])&&i[at]==B_PAWN){var $,tt;j=RANK[at];0!=(tt=(V&($=15<<(Ot=(nt=FILE[at])-1<<2)))>>>Ot)&&(L+=PAWN_DOUBLED_S,v+=PAWN_DOUBLED_E),j>tt&&(V=V&~$|j<<Ot),j<(G&$)>>>Ot&&(G=G&~$|j<<Ot),7==j&&(m=PTT_BHOME),q++,X++}else X++}w=V>>>4,k=V<<4,Z=G>>>4|2415919104,D=G<<4|9;for(X=this.firstWP,q=0;q<E;){if((at=this.wList[X])&&i[at]==W_PAWN){var st=0;if((U>>>(Ot=(nt=FILE[at])-1<<2)&15)==(j=RANK[at])&&(V>>>Ot&15)<j&&(st=1),9==(F>>>Ot&15)&&9==(z>>>Ot&15))L-=PAWN_ISOLATED_S+PAWN_ISOLATED_S*st,v-=PAWN_ISOLATED_E;else if((F>>>Ot&15)>j&&(z>>>Ot&15)>j){var it=!0;(!IS_WP[i[at-11]]&&!IS_WP[i[at-13]]||IS_P[i[at-12]]||IS_BP[i[at-11]]||IS_BP[i[at-13]]||IS_BP[i[at-23]]||IS_BP[i[at-25]])&&(2!=j||!IS_WP[i[at-23]]&&!IS_WP[i[at-25]]||IS_P[i[at-12]]||IS_P[i[at-24]]||IS_BP[i[at-11]]||IS_BP[i[at-13]]||IS_BP[i[at-23]]||IS_BP[i[at-25]]||IS_BP[i[at-37]]||IS_BP[i[at-35]])||(it=!1),it&&(L-=PAWN_BACKWARD_S+PAWN_BACKWARD_S*st,v-=PAWN_BACKWARD_E)}if(st)if((k>>>Ot&15)<=j&&(w>>>Ot&15)<=j)C=PTT_WPASS;else{for(var ht=0,et=at;i[et]!=EDGE;)ht+=IS_WP[i[et+1]],ht+=IS_WP[i[et-1]],et+=12;var St=0;for(et=at-12;i[et]!=EDGE;)St+=IS_BP[i[et+1]],St+=IS_BP[i[et-1]],et-=12;ht>=St&&(ht=IS_WP[i[at+11]]+IS_WP[i[at+13]])>=(St=IS_BP[i[at-11]]+IS_BP[i[at-13]])&&(L+=5+50*PAWN_PASSED[j]|0,v+=10+100*PAWN_PASSED[j]|0)}q++,X++}else X++}for(X=this.firstBP,q=0;q<A;){if((at=this.bList[X])&&i[at]==B_PAWN){st=0;if((G>>>(Ot=(nt=FILE[at])-1<<2)&15)==(j=RANK[at])&&(Q>>>Ot&15)>j&&(st=1),0==(k>>>Ot&15)&&0==(w>>>Ot&15))L+=PAWN_ISOLATED_S+PAWN_ISOLATED_S*st,v+=PAWN_ISOLATED_E;else if((k>>>Ot&15)<j&&(w>>>Ot&15)<j){it=!0;(!IS_BP[i[at+11]]&&!IS_BP[i[at+13]]||IS_P[i[at+12]]||IS_WP[i[at+11]]||IS_WP[i[at+13]]||IS_WP[i[at+23]]||IS_WP[i[at+25]])&&(7!=j||!IS_BP[i[at+23]]&&!IS_BP[i[at+25]]||IS_P[i[at+12]]||IS_P[i[at+24]]||IS_WP[i[at+11]]||IS_WP[i[at+13]]||IS_WP[i[at+23]]||IS_WP[i[at+25]]||IS_WP[i[at+37]]||IS_WP[i[at+35]])||(it=!1),it&&(L+=PAWN_BACKWARD_S+PAWN_BACKWARD_S*st,v+=PAWN_BACKWARD_E)}if(st)if((F>>>Ot&15)>=j&&(z>>>Ot&15)>=j)g=PTT_BPASS;else{for(ht=0,et=at;i[et]!=EDGE;)ht+=IS_BP[i[et+1]],ht+=IS_BP[i[et-1]],et-=12;for(St=0,et=at+12;i[et]!=EDGE;)St+=IS_WP[i[et+1]],St+=IS_WP[i[et-1]],et+=12;ht>=St&&(ht=IS_BP[i[at-11]]+IS_BP[i[at-13]])>=(St=IS_WP[i[at+11]]+IS_WP[i[at+13]])&&(L-=5+50*PAWN_PASSED[9-j]|0,v-=10+100*PAWN_PASSED[9-j]|0)}q++,X++}else X++}this.pttFlags[Y]=PTT_EXACT|b|m|C|g,this.pttLo[Y]=this.ploHash,this.pttHi[Y]=this.phiHash,this.pttScoreS[Y]=L,this.pttScoreE[Y]=v,this.pttwLeast[Y]=Q,this.pttbLeast[Y]=V,this.pttwMost[Y]=U,this.pttbMost[Y]=G}if(C)for(X=this.firstWP,q=0;q<E;){if((at=this.wList[X])&&i[at]==W_PAWN){et=at-12;if((U>>>(Ot=(nt=FILE[at])-1<<2)&15)==(j=RANK[at])&&(V>>>Ot&15)<j&&(k>>>Ot&15)<=j&&(w>>>Ot&15)<=j){var _t=20*DIST[B][et]-5*DIST[P][et],ot=0;i[et]||(ot=60*(0|!this.isAttacked(et,BLACK)));var rt=0;if(A+1==this.bCount){var Et=W_PROMOTE_SQ[nt];if(DIST[P][at]<=1&&DIST[P][Et]<=1)rt=800;else if(DIST[at][Et]<DIST[B][Et]+(t==WHITE|0)-1){for(;!i[et];)et-=12;i[et]==EDGE&&(rt=800)}}L+=10+60*PAWN_PASSED[j]|0,v+=20+(120+_t+ot+rt)*PAWN_PASSED[j]|0}q++,X++}else X++}if(g)for(X=this.firstBP,q=0;q<A;){var at;if((at=this.bList[X])&&i[at]==B_PAWN){var nt,Ot;et=at+12;if((G>>>(Ot=(nt=FILE[at])-1<<2)&15)==(j=RANK[at])&&(Q>>>Ot&15)>j&&(F>>>Ot&15)>=j&&(z>>>Ot&15)>=j){_t=20*DIST[P][et]-5*DIST[B][et],ot=0;i[et]||(ot=60*(0|!this.isAttacked(et,WHITE)));rt=0;if(E+1==this.wCount){Et=B_PROMOTE_SQ[nt];if(DIST[B][at]<=1&&DIST[B][Et]<=1)rt=800;else if(DIST[at][Et]<DIST[P][Et]+(t==BLACK|0)-1){for(;!i[et];)et+=12;i[et]==EDGE&&(rt=800)}}L-=10+60*PAWN_PASSED[9-j]|0,v-=20+(120+_t+ot+rt)*PAWN_PASSED[9-j]|0}q++,X++}else X++}K=0;var Tt=0;c&&(K=0,K+=2*WSHELTER[(Q&d)>>>u],8!=I&&(K+=WSHELTER[(z&d)>>>u]),1!=I&&(K+=WSHELTER[(F&d)>>>u]),0==K&&(K=11),Tt-=K,K=0,K+=WSTORM[(G&d)>>>u],8!=I&&(K+=WSTORM[(Z&d)>>>u]),1!=I&&(K+=WSTORM[(D&d)>>>u]),Tt-=K),R&&(K=0,K+=2*BSHELTER[(V&f)>>>p],8!=N&&(K+=BSHELTER[(w&f)>>>p]),1!=N&&(K+=BSHELTER[(k&f)>>>p]),0==K&&(K=11),Tt+=K,K=0,K+=BSTORM[(U&f)>>>p],8!=N&&(K+=BSTORM[(J&f)>>>p]),1!=N&&(K+=BSTORM[(y&f)>>>p]),Tt+=K);var At=0,Pt=0,Mt=0,It=0,Bt=0,lt=0,Nt=0,ut=0,dt=0,pt=0,ft=0,Kt=0,Ht=0,Wt=0,ct=0,Rt=0,Lt=0,vt=0,Ct=0,gt=0,bt=0,mt=0,Qt=0,Vt=0,Ut=this.wList,Gt=this.wCount-1-E;for(X=1,q=0;q<Gt;)if((Wt=Ut[X++])&&(ct=i[Wt])!=W_PAWN){if(Rt=RANK[Wt],Ct=15<<(vt=(Lt=FILE[Wt])-1<<2),ct==W_KNIGHT)Kt=0,Vt=0,Kt+=MOB_NIS[i[Ht=Wt+10]],Vt+=W[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt-10]],Vt+=W[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt+14]],Vt+=W[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt-14]],Vt+=W[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt+23]],Vt+=W[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt-23]],Vt+=W[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt+25]],Vt+=W[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt-25]],Vt+=W[Ht]*MOB_NIS[i[Ht]],At+=Kt*MOB_NS,Pt+=Kt*MOB_NE,Vt&&(mt++,Qt+=ATT_N),(Ft=WOUTPOST[Wt])&&(w&Ct)>>>vt<=Rt&&(k&Ct)>>>vt<=Rt&&(Bt+=Ft,Bt+=Ft*IS_WP[i[Wt+11]],Bt+=Ft*IS_WP[i[Wt+13]]);else if(ct==W_BISHOP){for(Kt=0,Vt=0,Ht=Wt+11;!i[Ht];)Vt+=W[Ht],Ht+=11,Kt++;for(Kt+=MOB_BIS[i[Ht]],Vt+=W[Ht]*MOB_BIS[i[Ht]],Ht=Wt-11;!i[Ht];)Vt+=W[Ht],Ht-=11,Kt++;for(Kt+=MOB_BIS[i[Ht]],Vt+=W[Ht]*MOB_BIS[i[Ht]],Ht=Wt+13;!i[Ht];)Vt+=W[Ht],Ht+=13,Kt++;for(Kt+=MOB_BIS[i[Ht]],Vt+=W[Ht]*MOB_BIS[i[Ht]],Ht=Wt-13;!i[Ht];)Vt+=W[Ht],Ht-=13,Kt++;Kt+=MOB_BIS[i[Ht]],Vt+=W[Ht]*MOB_BIS[i[Ht]],At+=Kt*MOB_BS,Pt+=Kt*MOB_BE,Vt&&(mt++,Qt+=ATT_B),gt+=WSQUARE[Wt],bt+=BSQUARE[Wt]}else if(ct==W_ROOK){for(Kt=0,Vt=0,Ht=Wt+1;!i[Ht];)Vt+=W[Ht],Ht+=1,Kt++;for(Kt+=MOB_RIS[i[Ht]],Vt+=W[Ht]*MOB_RIS[i[Ht]],Ht=Wt-1;!i[Ht];)Vt+=W[Ht],Ht-=1,Kt++;for(Kt+=MOB_RIS[i[Ht]],Vt+=W[Ht]*MOB_RIS[i[Ht]],Ht=Wt+12;!i[Ht];)Vt+=W[Ht],Ht+=12,Kt++;for(Kt+=MOB_RIS[i[Ht]],Vt+=W[Ht]*MOB_RIS[i[Ht]],Ht=Wt-12;!i[Ht];)Vt+=W[Ht],Ht-=12,Kt++;Kt+=MOB_RIS[i[Ht]],Vt+=W[Ht]*MOB_RIS[i[Ht]],At+=Kt*MOB_RS,Pt+=Kt*MOB_RE,Vt&&(mt++,Qt+=ATT_R),7!=Rt||8!=l&&!m||(ut+=20,dt+=40),ut-=10,dt-=10,U&Ct||(ut+=10,dt+=10,V&Ct||(ut+=10,dt+=10),Lt==N&&(ut+=10),Math.abs(Lt-N)<=1&&(ut+=10))}else if(ct==W_QUEEN){for(Kt=0,Vt=0,Ht=Wt+1;!i[Ht];)Vt+=W[Ht],Ht+=1,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=W[Ht]*MOB_QIS[i[Ht]],Ht=Wt-1;!i[Ht];)Vt+=W[Ht],Ht-=1,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=W[Ht]*MOB_QIS[i[Ht]],Ht=Wt+12;!i[Ht];)Vt+=W[Ht],Ht+=12,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=W[Ht]*MOB_QIS[i[Ht]],Ht=Wt-12;!i[Ht];)Vt+=W[Ht],Ht-=12,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=W[Ht]*MOB_QIS[i[Ht]],Ht=Wt+11;!i[Ht];)Vt+=W[Ht],Ht+=11,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=W[Ht]*MOB_QIS[i[Ht]],Ht=Wt-11;!i[Ht];)Vt+=W[Ht],Ht-=11,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=W[Ht]*MOB_QIS[i[Ht]],Ht=Wt+13;!i[Ht];)Vt+=W[Ht],Ht+=13,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=W[Ht]*MOB_QIS[i[Ht]],Ht=Wt-13;!i[Ht];)Vt+=W[Ht],Ht-=13,Kt++;Kt+=MOB_QIS[i[Ht]],Vt+=W[Ht]*MOB_QIS[i[Ht]],At+=Kt*MOB_QS,Pt+=Kt*MOB_QE,Vt&&(mt++,Qt+=ATT_Q),7!=Rt||8!=l&&!m||(pt+=10,ft+=20)}q++}R&&(mt>ATT_L&&(mt=ATT_L),Mt+=Qt*ATT_M*ATT_W[mt]|0,It+=0),gt&&bt&&(lt+=50,Nt+=50);for(Kt=0,Ht=0,Wt=0,ct=0,Rt=0,Lt=0,vt=0,Ct=0,gt=0,bt=0,mt=0,Qt=0,Vt=0,Ut=this.bList,Gt=this.bCount-1-A,X=1,q=0;q<Gt;)if((Wt=Ut[X++])&&(ct=i[Wt])!=B_PAWN){var Ft;if(Rt=RANK[Wt],Ct=15<<(vt=(Lt=FILE[Wt])-1<<2),ct==B_KNIGHT)Kt=0,Vt=0,Kt+=MOB_NIS[i[Ht=Wt+10]],Vt+=H[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt-10]],Vt+=H[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt+14]],Vt+=H[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt-14]],Vt+=H[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt+23]],Vt+=H[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt-23]],Vt+=H[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt+25]],Vt+=H[Ht]*MOB_NIS[i[Ht]],Kt+=MOB_NIS[i[Ht=Wt-25]],Vt+=H[Ht]*MOB_NIS[i[Ht]],At-=Kt*MOB_NS,Pt-=Kt*MOB_NE,Vt&&(mt++,Qt+=ATT_N),(Ft=BOUTPOST[Wt])&&(z&Ct)>>>vt>=Rt&&(F&Ct)>>>vt>=Rt&&(Bt-=Ft,Bt-=Ft*IS_BP[i[Wt-11]],Bt-=Ft*IS_BP[i[Wt-13]]);else if(ct==B_BISHOP){for(Kt=0,Vt=0,Ht=Wt+11;!i[Ht];)Vt+=H[Ht],Ht+=11,Kt++;for(Kt+=MOB_BIS[i[Ht]],Vt+=H[Ht]*MOB_BIS[i[Ht]],Ht=Wt-11;!i[Ht];)Vt+=H[Ht],Ht-=11,Kt++;for(Kt+=MOB_BIS[i[Ht]],Vt+=H[Ht]*MOB_BIS[i[Ht]],Ht=Wt+13;!i[Ht];)Vt+=H[Ht],Ht+=13,Kt++;for(Kt+=MOB_BIS[i[Ht]],Vt+=H[Ht]*MOB_BIS[i[Ht]],Ht=Wt-13;!i[Ht];)Vt+=H[Ht],Ht-=13,Kt++;Kt+=MOB_BIS[i[Ht]],Vt+=H[Ht]*MOB_BIS[i[Ht]],At-=Kt*MOB_BS,Pt-=Kt*MOB_BE,Vt&&(mt++,Qt+=ATT_B),gt+=WSQUARE[Wt],bt+=BSQUARE[Wt]}else if(ct==B_ROOK){for(Kt=0,Vt=0,Ht=Wt+1;!i[Ht];)Vt+=H[Ht],Ht+=1,Kt++;for(Kt+=MOB_RIS[i[Ht]],Vt+=H[Ht]*MOB_RIS[i[Ht]],Ht=Wt-1;!i[Ht];)Vt+=H[Ht],Ht-=1,Kt++;for(Kt+=MOB_RIS[i[Ht]],Vt+=H[Ht]*MOB_RIS[i[Ht]],Ht=Wt+12;!i[Ht];)Vt+=H[Ht],Ht+=12,Kt++;for(Kt+=MOB_RIS[i[Ht]],Vt+=H[Ht]*MOB_RIS[i[Ht]],Ht=Wt-12;!i[Ht];)Vt+=H[Ht],Ht-=12,Kt++;Kt+=MOB_RIS[i[Ht]],Vt+=H[Ht]*MOB_RIS[i[Ht]],At-=Kt*MOB_RS,Pt-=Kt*MOB_RE,Vt&&(mt++,Qt+=ATT_R),2!=Rt||1!=M&&!b||(ut-=20,dt-=40),ut+=10,dt+=10,V&Ct||(ut-=10,dt-=10,U&Ct||(ut-=10,dt-=10),Lt==I&&(ut-=10),Math.abs(Lt-I)<=1&&(ut-=10))}else if(ct==B_QUEEN){for(Kt=0,Vt=0,Ht=Wt+1;!i[Ht];)Vt+=H[Ht],Ht+=1,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=H[Ht]*MOB_QIS[i[Ht]],Ht=Wt-1;!i[Ht];)Vt+=H[Ht],Ht-=1,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=H[Ht]*MOB_QIS[i[Ht]],Ht=Wt+12;!i[Ht];)Vt+=H[Ht],Ht+=12,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=H[Ht]*MOB_QIS[i[Ht]],Ht=Wt-12;!i[Ht];)Vt+=H[Ht],Ht-=12,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=H[Ht]*MOB_QIS[i[Ht]],Ht=Wt+11;!i[Ht];)Vt+=H[Ht],Ht+=11,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=H[Ht]*MOB_QIS[i[Ht]],Ht=Wt-11;!i[Ht];)Vt+=H[Ht],Ht-=11,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=H[Ht]*MOB_QIS[i[Ht]],Ht=Wt+13;!i[Ht];)Vt+=H[Ht],Ht+=13,Kt++;for(Kt+=MOB_QIS[i[Ht]],Vt+=H[Ht]*MOB_QIS[i[Ht]],Ht=Wt-13;!i[Ht];)Vt+=H[Ht],Ht-=13,Kt++;Kt+=MOB_QIS[i[Ht]],Vt+=H[Ht]*MOB_QIS[i[Ht]],At-=Kt*MOB_QS,Pt-=Kt*MOB_QE,Vt&&(mt++,Qt+=ATT_Q),2!=Rt||1!=M&&!b||(pt-=10,ft-=20)}q++}c&&(mt>ATT_L&&(mt=ATT_L),Mt-=Qt*ATT_M*ATT_W[mt]|0,It-=0),gt&&bt&&(lt-=50,Nt-=50);var kt=0,yt=0,Dt=0;if(o&&(Dt=0,Dt+=IS_WB[i[SQA7]]&IS_BP[i[SQB6]],Dt+=IS_WB[i[SQH7]]&IS_BP[i[SQG6]],Dt+=IS_WB[i[SQB8]]&IS_BP[i[SQC7]],Dt+=IS_WB[i[SQG7]]&IS_BP[i[SQF7]],Dt+=IS_WB[i[SQA6]]&IS_BP[i[SQB5]],Dt+=IS_WB[i[SQH6]]&IS_BP[i[SQG5]],Dt+=IS_WB[i[SQC1]]&IS_WP[i[SQD2]]&IS_O[i[SQD3]],kt-=100*(Dt+=IS_WB[i[SQF1]]&IS_WP[i[SQE2]]&IS_O[i[SQE3]]),yt-=100*Dt),O&&(Dt=0,Dt+=IS_BB[i[SQA2]]&IS_WP[i[SQB3]],Dt+=IS_BB[i[SQH2]]&IS_WP[i[SQG3]],Dt+=IS_BB[i[SQB1]]&IS_WP[i[SQC2]],Dt+=IS_BB[i[SQG2]]&IS_WP[i[SQF2]],Dt+=IS_BB[i[SQA3]]&IS_WP[i[SQB4]],Dt+=IS_BB[i[SQH3]]&IS_WP[i[SQG4]],Dt+=IS_BB[i[SQC8]]&IS_BP[i[SQD7]]*IS_O[i[SQD6]],kt+=100*(Dt+=IS_BB[i[SQF8]]&IS_BP[i[SQE7]]*IS_O[i[SQE6]]),yt+=100*Dt),r&&(Dt=0,Dt+=IS_WN[i[SQA8]]&(IS_BP[i[SQA7]]|IS_BP[i[SQC7]]),Dt+=IS_WN[i[SQH8]]&(IS_BP[i[SQH7]]|IS_BP[i[SQF7]]),Dt+=IS_WN[i[SQA7]]&IS_BP[i[SQA6]]&IS_BP[i[SQB7]],Dt+=IS_WN[i[SQH7]]&IS_BP[i[SQH6]]&IS_BP[i[SQG7]],Dt+=IS_WN[i[SQA7]]&IS_BP[i[SQB7]]&IS_BP[i[SQC6]],kt-=100*(Dt+=IS_WN[i[SQH7]]&IS_BP[i[SQG7]]&IS_BP[i[SQF6]]),yt-=100*Dt),T&&(Dt=0,Dt+=IS_BN[i[SQA1]]&(IS_WP[i[SQA2]]|IS_WP[i[SQC2]]),Dt+=IS_BN[i[SQH1]]&(IS_WP[i[SQH2]]|IS_WP[i[SQF2]]),Dt+=IS_BN[i[SQA2]]&IS_WP[i[SQA3]]&IS_WP[i[SQB2]],Dt+=IS_BN[i[SQH2]]&IS_WP[i[SQH3]]&IS_WP[i[SQG2]],Dt+=IS_BN[i[SQA2]]&IS_WP[i[SQB2]]&IS_WP[i[SQC3]],kt+=100*(Dt+=IS_BN[i[SQH2]]&IS_WP[i[SQG2]]&IS_WP[i[SQF3]]),yt+=100*Dt),t==WHITE)var zt=20,wt=10;else zt=-20,wt=-10;var Jt=this.runningEvalS,Zt=this.runningEvalE,Yt=(this.wCount,this.bCount,0),xt=0;this.turn==WHITE?Jt>120?Yt=1:Jt<-120&&(xt=1):Jt>120?xt=1:Jt<-120&&(Yt=1),Yt?this.turn:xt&&this.turn,Jt+=At,Zt+=Pt,Jt+=kt,Zt+=yt,Jt+=zt,Zt+=wt,Jt+=Mt,Zt+=It,Jt+=L,Zt+=v,Jt+=Bt,Zt+=0,Jt+=lt,Zt+=Nt,Jt+=ut,Zt+=dt,Jt+=pt,Zt+=ft,Zt+=0;var Xt=(Jt+=Tt)*(256-this.gPhase)+Zt*this.gPhase>>8;return this.verbose&&(s.send("info string","phased eval","PH",this.gPhase,"VAL",Xt),s.send("info string","evaluation","MG",Jt,"EG",Zt),s.send("info string","trapped","MG",kt,"EG",yt),s.send("info string","mobility","MG",At,"EG",Pt),s.send("info string","attacks","MG",Mt,"EG",It),s.send("info string","material","MG",this.runningEvalS,"EG",this.runningEvalE),s.send("info string","king","MG",Tt,"EG",0),s.send("info string","queens","MG",pt,"EG",ft),s.send("info string","rooks","MG",ut,"EG",dt),s.send("info string","bishops","MG",lt,"EG",Nt),s.send("info string","knights","MG",Bt,"EG",0),s.send("info string","pawns","MG",L,"EG",v),s.send("info string","home pawn","W",0!=b,"B",0!=m),s.send("info string","tempo","MG",zt,"EG",wt)),Xt*=-t>>31|1},lozBoard.prototype.rand32=function(){return 4294967295*Math.random()|0},lozBoard.prototype.ttPut=function(t,s,i,h,e,S,_){var o=this.loHash&TTMASK;this.ttType[o]==TT_EMPTY&&this.hashUsed++,i<=-MINMATE&&i>=-MATE?i-=e:i>=MINMATE&&i<=MATE&&(i+=e),this.ttLo[o]=this.loHash,this.ttHi[o]=this.hiHash,this.ttType[o]=t,this.ttDepth[o]=s,this.ttScore[o]=i,this.ttMove[o]=h},lozBoard.prototype.ttGet=function(t,s,i,h){var e=this.loHash&TTMASK,S=this.ttType[e];if(t.hashMove=0,S==TT_EMPTY)return TTSCORE_UNKNOWN;var _=this.ttLo[e],o=this.ttHi[e];if(_!=this.loHash||o!=this.hiHash)return TTSCORE_UNKNOWN;if(t.hashMove=this.ttMove[e],this.ttDepth[e]<s)return TTSCORE_UNKNOWN;var r=this.ttScore[e];return r<=-MINMATE&&r>=-MATE?r+=t.ply:r>=MINMATE&&r<=MATE&&(r-=t.ply),S==TT_EXACT?r:S==TT_ALPHA&&r<=i?r:S==TT_BETA&&r>=h?r:TTSCORE_UNKNOWN},lozBoard.prototype.ttGetMove=function(t){var s=this.loHash&TTMASK;return this.ttType[s]!=TT_EMPTY&&this.ttLo[s]==this.loHash&&this.ttHi[s]==this.hiHash?this.ttMove[s]:0},lozBoard.prototype.ttInit=function(){this.loHash=0,this.hiHash=0,this.ploHash=0,this.phiHash=0;for(var t=0;t<TTSIZE;t++)this.ttType[t]=TT_EMPTY;for(t=0;t<PTTSIZE;t++)this.pttFlags[t]=TT_EMPTY;this.hashUsed=0},lozBoard.prototype.hashCheck=function(t){var s=0,i=0,h=0,e=0;t&&(s^=this.loTurn,i^=this.hiTurn),s^=this.loRights[this.rights],i^=this.hiRights[this.rights],s^=this.loEP[this.ep],i^=this.hiEP[this.ep];for(var S=0;S<144;S++){var _=this.b[S];if(_!=NULL&&_!=EDGE){var o=_&PIECE_MASK,r=_&COLOR_MASK;s^=this.loPieces[r>>>3][o-1][S],i^=this.hiPieces[r>>>3][o-1][S],o==PAWN&&(h^=this.loPieces[r>>>3][0][S],e^=this.hiPieces[r>>>3][0][S])}}this.loHash!=s&&lozza.uci.debug("*************** LO",this.loHash,s),this.hiHash!=i&&lozza.uci.debug("*************** HI",this.hiHash,i),this.ploHash!=h&&lozza.uci.debug("************* PLO",this.ploHash,h),this.phiHash!=e&&lozza.uci.debug("************* PHI",this.phiHash,e)},lozBoard.prototype.fen=function(t){for(var s="",i=0,h=0;h<8;h++){for(var e=0;e<8;e++){var S=B88[8*h+e],_=this.b[S];_==NULL?i++:(i&&(s+=""+i,i=0),s+=UMAP[_])}i&&(s+=""+i,i=0),h<7&&(s+="/")}return s+=t==WHITE?" w":" b",this.rights?(s+=" ",this.rights&WHITE_RIGHTS_KING&&(s+="K"),this.rights&WHITE_RIGHTS_QUEEN&&(s+="Q"),this.rights&BLACK_RIGHTS_KING&&(s+="k"),this.rights&BLACK_RIGHTS_QUEEN&&(s+="Q")):s+=" -",this.ep?s+=" "+COORDS[this.ep]:s+=" -",s+=" 0 1"},lozBoard.prototype.playMove=function(t){var s=0,i=lozza.rootNode,h=~this.turn&COLOR_MASK;for(i.cache(),this.genMoves(i,this.turn);s=i.getNextMove();){if(this.makeMove(i,s),this.isKingAttacked(h))this.unmakeMove(i,s),i.uncache();else{var e=this.formatMove(s,UCI_FMT);if(t==e||t+"q"==e)return this.turn=~this.turn&COLOR_MASK,!0;this.unmakeMove(i,s),i.uncache()}}return!1},lozBoard.prototype.getPVStr=function(t,s,i){if(!t||!i)return"";if(s||(s=this.ttGetMove(t)),!s)return"";t.cache(),this.makeMove(t,s);var h=this.formatMove(s,this.mvFmt),e=" "+this.getPVStr(t.childNode,0,i-1);return this.unmakeMove(t,s),t.uncache(),h+e},lozBoard.prototype.addHistory=function(t,s){var i=(s&MOVE_TO_MASK)>>>MOVE_TO_BITS,h=(s&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS,e=h&PIECE_MASK;(h&COLOR_MASK)==WHITE?this.wHistory[e][i]+=t*t:this.bHistory[e][i]+=t*t},lozBoard.prototype.betaMate=function(t){return t>=MINMATE&&t<=MATE},lozBoard.prototype.alphaMate=function(t){return t<=-MINMATE&&t>=-MATE};var BASE_HASH=10000012e3,BASE_PROMOTES=10000011e3,BASE_GOODTAKES=1000001e4,BASE_EVENTAKES=10000009e3,BASE_EPTAKES=10000008e3,BASE_MATEKILLER=10000007e3,BASE_MYKILLERS=10000006e3,BASE_GPKILLERS=10000005e3,BASE_CASTLING=10000004e3,BASE_BADTAKES=10000003e3,BASE_HISSLIDE=2e3,BASE_PSTSLIDE=1e3,BASE_LMR=BASE_BADTAKES;function lozNode(t){this.ply=0,this.root=!1,this.childNode=null,this.parentNode=t,t?(this.grandparentNode=t.parentNode,t.childNode=this):this.grandparentNode=null,this.moves=new Uint32Array(MAX_MOVES),this.ranks=Array(MAX_MOVES);for(var s=0;s<MAX_MOVES;s++)this.moves[s]=0,this.ranks[s]=0;this.killer1=0,this.killer2=0,this.mateKiller=0,this.numMoves=0,this.sortedIndex=0,this.hashMove=0,this.base=0,this.C_runningEvalS=0,this.C_runningEvalE=0,this.C_rights=0,this.C_ep=0,this.C_repLo=0,this.C_repHi=0,this.C_loHash=0,this.C_hiHash=0,this.C_ploHash=0,this.C_phiHash=0,this.toZ=0,this.frZ=0,this.epZ=0}lozNode.prototype.init=function(){this.killer1=0,this.killer2=0,this.mateKiller=0,this.numMoves=0,this.sortedIndex=0,this.hashMove=0,this.base=0,this.toZ=0,this.frZ=0,this.epZ=0},lozNode.prototype.cache=function(){var t=this.board;this.C_runningEvalS=t.runningEvalS,this.C_runningEvalE=t.runningEvalE,this.C_rights=t.rights,this.C_ep=t.ep,this.C_repLo=t.repLo,this.C_repHi=t.repHi,this.C_loHash=t.loHash,this.C_hiHash=t.hiHash,this.C_ploHash=t.ploHash,this.C_phiHash=t.phiHash},lozNode.prototype.uncache=function(){var t=this.board;t.runningEvalS=this.C_runningEvalS,t.runningEvalE=this.C_runningEvalE,t.rights=this.C_rights,t.ep=this.C_ep,t.repLo=this.C_repLo,t.repHi=this.C_repHi,t.loHash=this.C_loHash,t.hiHash=this.C_hiHash,t.ploHash=this.C_ploHash,t.phiHash=this.C_phiHash},lozNode.prototype.getNextMove=function(){if(this.sortedIndex==this.numMoves)return 0;for(var t=-INFINITY,s=0,i=this.sortedIndex;i<this.numMoves;i++)this.ranks[i]>t&&(t=this.ranks[i],s=i);var h=this.moves[s];return this.moves[s]=this.moves[this.sortedIndex],this.ranks[s]=this.ranks[this.sortedIndex],this.base=t,this.sortedIndex++,h},lozNode.prototype.addSlide=function(t){var s=this.numMoves++;this.moves[s]=t,t==this.hashMove?this.ranks[s]=BASE_HASH:t==this.mateKiller?this.ranks[s]=BASE_MATEKILLER:t==this.killer1?this.ranks[s]=BASE_MYKILLERS+1:t==this.killer2?this.ranks[s]=BASE_MYKILLERS:this.grandparentNode&&t==this.grandparentNode.killer1?this.ranks[s]=BASE_GPKILLERS+1:this.grandparentNode&&t==this.grandparentNode.killer2?this.ranks[s]=BASE_GPKILLERS:this.ranks[s]=this.slideBase(t)},lozNode.prototype.slideBase=function(t){var s=(t&MOVE_TO_MASK)>>>MOVE_TO_BITS,i=(t&MOVE_FR_MASK)>>>MOVE_FR_BITS,h=(t&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS,e=h&PIECE_MASK;if((h&COLOR_MASK)==WHITE)var S=WM_PST[e],_=this.board.wHistory[e][s];else S=BM_PST[e],_=this.board.bHistory[e][s];return _?BASE_HISSLIDE+_:BASE_PSTSLIDE+S[s]-S[i]},lozNode.prototype.addCastle=function(t){var s=this.numMoves++;this.moves[s]=t,t==this.hashMove?this.ranks[s]=BASE_HASH:t==this.mateKiller?this.ranks[s]=BASE_MATEKILLER:t==this.killer1?this.ranks[s]=BASE_MYKILLERS+1:t==this.killer2?this.ranks[s]=BASE_MYKILLERS:this.grandparentNode&&t==this.grandparentNode.killer1?this.ranks[s]=BASE_GPKILLERS+1:this.grandparentNode&&t==this.grandparentNode.killer2?this.ranks[s]=BASE_GPKILLERS:this.ranks[s]=BASE_CASTLING},lozNode.prototype.addCapture=function(t){var s=this.numMoves++;if(this.moves[s]=t,t==this.hashMove)this.ranks[s]=BASE_HASH;else{var i=RANK_VECTOR[(t&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS&PIECE_MASK],h=RANK_VECTOR[(t&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS&PIECE_MASK];i>h?this.ranks[s]=BASE_GOODTAKES+64*i-h:i==h?this.ranks[s]=BASE_EVENTAKES+64*i-h:t==this.mateKiller?this.ranks[s]=BASE_MATEKILLER:t==this.killer1?this.ranks[s]=BASE_MYKILLERS+1:t==this.killer2?this.ranks[s]=BASE_MYKILLERS:this.grandparentNode&&t==this.grandparentNode.killer1?this.ranks[s]=BASE_GPKILLERS+1:this.grandparentNode&&t==this.grandparentNode.killer2?this.ranks[s]=BASE_GPKILLERS:this.ranks[s]=BASE_BADTAKES+64*i-h}};var QPRO=QUEEN-2<<MOVE_PROMAS_BITS|MOVE_PROMOTE_MASK,RPRO=ROOK-2<<MOVE_PROMAS_BITS|MOVE_PROMOTE_MASK,BPRO=BISHOP-2<<MOVE_PROMAS_BITS|MOVE_PROMOTE_MASK,NPRO=KNIGHT-2<<MOVE_PROMAS_BITS|MOVE_PROMOTE_MASK;function lozStats(){}function lozUCI(){this.message="",this.tokens=[],this.command="",this.spec={},this.debugging=!0,this.nodefs=0,this.numMoves=0,this.options={}}lozNode.prototype.addPromotion=function(t){var s=0;s=this.numMoves++,this.moves[s]=t|QPRO,(t|QPRO)==this.hashMove?this.ranks[s]=BASE_HASH:this.ranks[s]=BASE_PROMOTES+QUEEN,s=this.numMoves++,this.moves[s]=t|RPRO,(t|RPRO)==this.hashMove?this.ranks[s]=BASE_HASH:this.ranks[s]=BASE_PROMOTES+ROOK,s=this.numMoves++,this.moves[s]=t|BPRO,(t|BPRO)==this.hashMove?this.ranks[s]=BASE_HASH:this.ranks[s]=BASE_PROMOTES+BISHOP,s=this.numMoves++,this.moves[s]=t|NPRO,(t|NPRO)==this.hashMove?this.ranks[s]=BASE_HASH:this.ranks[s]=BASE_PROMOTES+KNIGHT},lozNode.prototype.addEPTake=function(t){var s=this.numMoves++;this.moves[s]=t|MOVE_EPTAKE_MASK,(t|MOVE_EPTAKE_MASK)==this.hashMove?this.ranks[s]=BASE_HASH:this.ranks[s]=BASE_EPTAKES},lozNode.prototype.addQMove=function(t){var s=this.numMoves++;if(this.moves[s]=t,t&MOVE_PROMOTE_MASK)this.ranks[s]=BASE_PROMOTES+((t&MOVE_PROMAS_MASK)>>>MOVE_PROMAS_BITS);else if(t&MOVE_EPTAKE_MASK)this.ranks[s]=BASE_EPTAKES;else{var i=RANK_VECTOR[(t&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS&PIECE_MASK],h=RANK_VECTOR[(t&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS&PIECE_MASK];this.ranks[s]=i>h?BASE_GOODTAKES+64*i-h:i==h?BASE_EVENTAKES+64*i-h:BASE_BADTAKES+64*i-h}},lozNode.prototype.addQPromotion=function(t){this.addQMove(t|QUEEN-2<<MOVE_PROMAS_BITS),this.addQMove(t|ROOK-2<<MOVE_PROMAS_BITS),this.addQMove(t|BISHOP-2<<MOVE_PROMAS_BITS),this.addQMove(t|KNIGHT-2<<MOVE_PROMAS_BITS)},lozNode.prototype.addKiller=function(t,s){if(s!=this.hashMove&&!(s&(MOVE_EPTAKE_MASK|MOVE_PROMOTE_MASK))){if(s&MOVE_TOOBJ_MASK)if(RANK_VECTOR[(s&MOVE_TOOBJ_MASK)>>>MOVE_TOOBJ_BITS&PIECE_MASK]>=RANK_VECTOR[(s&MOVE_FROBJ_MASK)>>>MOVE_FROBJ_BITS&PIECE_MASK])return;if(t>=MINMATE&&t<=MATE)return this.mateKiller=s,this.killer1==s&&(this.killer1=0),void(this.killer2==s&&(this.killer2=0));if(this.killer1!=s&&this.killer2!=s)if(0!=this.killer1)if(0!=this.killer2){var i=this.killer1;this.killer1=s,this.killer2=i}else this.killer2=s;else this.killer1=s}},lozStats.prototype.init=function(){this.startTime=Date.now(),this.splitTime=0,this.nodes=0,this.ply=0,this.splits=0,this.moveTime=0,this.maxNodes=0,this.timeOut=0,this.selDepth=0,this.bestMove=0},lozStats.prototype.lazyUpdate=function(){this.moveTime>0&&Date.now()-this.startTime>this.moveTime&&(this.timeOut=1),this.maxNodes>0&&this.nodes>=this.maxNodes&&(this.timeOut=1),Date.now()-this.splitTime>500&&(this.splits++,this.update(),this.splitTime=Date.now())},lozStats.prototype.nodeStr=function(){var t=Date.now()-this.startTime,s=1e3*this.nodes/t|0;return"nodes "+this.nodes+" time "+t+" nps "+s},lozStats.prototype.update=function(){var t=Date.now()-this.startTime;this.nodes;lozza.uci.send("info",this.nodeStr())},lozStats.prototype.stop=function(){this.stopTime=Date.now(),this.time=this.stopTime-this.startTime,this.timeSec=Math.round(this.time/100)/10,this.nodesMega=Math.round(this.nodes/1e5)/10},lozUCI.prototype.post=function(t){lozzaHost==HOST_NODEJS?this.nodefs.writeSync(1,t+"\n"):lozzaHost==HOST_JSUCI?postMessage(t):lozzaHost==HOST_WEB?postMessage(t):console.log(t)},lozUCI.prototype.send=function(){for(var t="",s=0;s<arguments.length;s++)t+=arguments[s]+" ";this.post(t)},lozUCI.prototype.debug=function(){if(this.debugging){for(var t="",s=0;s<arguments.length;s++)t+=arguments[s]+" ";(t=t.trim())?this.post("info string debug "+this.spec.id+" "+t):this.post("info string debug ")}},lozUCI.prototype.getInt=function(t,s){for(var i=0;i<this.tokens.length;i++)if(this.tokens[i]==t&&i<this.tokens.length-1)return parseInt(this.tokens[i+1]);return s},lozUCI.prototype.getStr=function(t,s){for(var i=0;i<this.tokens.length;i++)if(this.tokens[i]==t&&i<this.tokens.length-1)return this.tokens[i+1];return s},lozUCI.prototype.getArr=function(t,s){for(var i=0,h=0,e=0;e<this.tokens.length;e++)if(this.tokens[e]==t){h=i=e+1;for(var S=i;S<this.tokens.length&&this.tokens[S]!=s;S++)h=S}return{lo:i,hi:h}},onmessage=function(t){var s=lozza.uci;s.messageList=t.data.split("\n");for(var i=0;i<s.messageList.length;i++)if(s.message=s.messageList[i].replace(/(\r\n|\n|\r)/gm,""),s.message=s.message.trim(),s.message=s.message.replace(/\s+/g," "),s.tokens=s.message.split(" "),s.command=s.tokens[0],s.command)switch("u"==s.command&&(s.command="ucinewgame"),"b"==s.command&&(s.command="board"),"q"==s.command&&(s.command="quit"),"p"==s.command&&(s.command="position","s"==s.tokens[1]&&(s.tokens[1]="startpos")),"g"==s.command&&(s.command="go","d"==s.tokens[1]&&(s.tokens[1]="depth")),s.command){case"position":var h;if(s.spec.board="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",s.spec.turn="w",s.spec.rights="KQkq",s.spec.ep="-",s.spec.hmc=0,s.spec.fmc=1,s.spec.id="",(h=s.getArr("fen","moves")).lo>0&&(h.lo<=h.hi&&(s.spec.board=s.tokens[h.lo]),h.lo++,h.lo<=h.hi&&(s.spec.turn=s.tokens[h.lo]),h.lo++,h.lo<=h.hi&&(s.spec.rights=s.tokens[h.lo]),h.lo++,h.lo<=h.hi&&(s.spec.ep=s.tokens[h.lo]),h.lo++,h.lo<=h.hi&&(s.spec.hmc=parseInt(s.tokens[h.lo])),h.lo++,h.lo<=h.hi&&(s.spec.fmc=parseInt(s.tokens[h.lo])),h.lo++),s.spec.moves=[],(h=s.getArr("moves","fen")).lo>0)for(var e=h.lo;e<=h.hi;e++)s.spec.moves.push(s.tokens[e]);lozza.position();break;case"go":if(!s.spec.board)return void s.send("info string send a position command first and a ucinewgame before that if you need to reset the hash");s.spec.depth=s.getInt("depth",0),s.spec.moveTime=s.getInt("movetime",0),s.spec.maxNodes=s.getInt("nodes",0),s.spec.wTime=s.getInt("wtime",0),s.spec.bTime=s.getInt("btime",0),s.spec.wInc=s.getInt("winc",0),s.spec.bInc=s.getInt("binc",0),s.spec.movesToGo=s.getInt("movestogo",0),s.numMoves++,lozza.go();break;case"ucinewgame":lozza.newGameInit();break;case"quit":lozzaHost==HOST_NODEJS?process.exit():close();break;case"debug":"on"==s.getStr("debug","off")?s.debugging=!0:s.debugging=!1;break;case"uci":s.send("id name Lozza",BUILD),s.send("id author Colin Jenkins"),s.send("option"),s.send("uciok");break;case"isready":s.send("readyok");break;case"setoption":var S=s.getStr("name"),_=s.getStr("value");s.options[S]=_;break;case"ping":s.send("info string Lozza build",BUILD,HOSTS[lozzaHost],"is alive");break;case"id":s.spec.id=s.tokens[1];break;case"perft":s.spec.depth=s.getInt("depth",0),s.spec.moves=s.getInt("moves",0),s.spec.inner=s.getInt("inner",0),lozza.perft();break;case"eval":lozza.board.verbose=!0,lozza.board.evaluate(lozza.board.turn),lozza.board.verbose=!1;break;case"board":s.send("board",lozza.board.fen());break;default:s.send("info string","unknown command",s.command)}};var lozza=new lozChess;lozza.board.lozza=lozza,lozzaHost==HOST_NODEJS&&(lozza.uci.nodefs=require("fs"),process.stdin.setEncoding("utf8"),process.stdin.on("readable",function(){var t=process.stdin.read();null!==t&&onmessage({data:t})}),process.stdin.on("end",function(){process.exit()}));